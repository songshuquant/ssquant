<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SSQuant AI Agent - é‡åŒ–ç­–ç•¥æ™ºèƒ½ä½“</title>
    
    <!-- Monaco Editor - æœ¬åœ°åŒ– -->
    <link rel="stylesheet" href="/static/node_modules/monaco-editor/min/vs/editor/editor.main.css">
    
    <!-- Fonts - ä½¿ç”¨ç³»ç»Ÿå­—ä½“ï¼ˆæ— éœ€å¤–éƒ¨åŠ è½½ï¼Œæ›´å¿«ï¼‰ -->
    <style>
        /* ä½¿ç”¨ç³»ç»Ÿå­—ä½“æ ˆï¼Œæ— éœ€ä¸‹è½½ */
        :root {
            /* ä»£ç å­—ä½“ï¼šä¼˜å…ˆä½¿ç”¨ç³»ç»Ÿç­‰å®½å­—ä½“ */
            --font-mono: 'Cascadia Code', 'Fira Code', 'JetBrains Mono', Consolas, 'Courier New', monospace;
            /* ç•Œé¢å­—ä½“ï¼šä¼˜å…ˆä½¿ç”¨ç³»ç»Ÿä¸­æ–‡å­—ä½“ */
            --font-sans: 'Microsoft YaHei', 'PingFang SC', 'Hiragino Sans GB', 'Noto Sans SC', -apple-system, BlinkMacSystemFont, sans-serif;
        }
    </style>
    
    <!-- Favicon é¿å…404 -->
    <link rel="icon" href="data:,">
    
    <!-- Marked for Markdown - æœ¬åœ°åŒ– -->
    <script src="/static/node_modules/marked/marked.min.js"></script>
    <script>
        // å®‰å…¨çš„ marked.parse å°è£…ï¼ˆå¸¦ fallbackï¼‰
        function safeMarkedParse(text) {
            if (typeof marked !== 'undefined' && marked.parse) {
                return marked.parse(text);
            }
            // fallback: ç®€å•çš„ markdown è½¬æ¢
            if (!text) return '';
            return text
                .replace(/```(\w*)\n([\s\S]*?)```/g, '<pre><code class="language-$1">$2</code></pre>')
                .replace(/`([^`]+)`/g, '<code>$1</code>')
                .replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>')
                .replace(/\*([^*]+)\*/g, '<em>$1</em>')
                .replace(/^### (.+)$/gm, '<h3>$1</h3>')
                .replace(/^## (.+)$/gm, '<h2>$1</h2>')
                .replace(/^# (.+)$/gm, '<h1>$1</h1>')
                .replace(/^- (.+)$/gm, '<li>$1</li>')
                .replace(/^(\d+)\. (.+)$/gm, '<li>$2</li>')
                .replace(/\n/g, '<br>');
        }
        
        // ==================== èµ„æºåŠ è½½çŠ¶æ€æ£€æŸ¥ ====================
        console.log('%c========== SSQuant AI Agent èµ„æºåŠ è½½çŠ¶æ€ ==========', 'color: #3b82f6; font-weight: bold; font-size: 14px;');
        
        // æ£€æŸ¥ marked.js
        if (typeof marked !== 'undefined' && marked.parse) {
            console.log('%câœ… marked.js åŠ è½½æˆåŠŸ', 'color: #10b981; font-weight: bold;', '- ç‰ˆæœ¬:', marked.version || 'unknown');
        } else {
            console.log('%câŒ marked.js åŠ è½½å¤±è´¥ (ä½¿ç”¨ fallback)', 'color: #ef4444; font-weight: bold;');
        }
        
        // é¡µé¢åŠ è½½å®Œæˆåæ£€æŸ¥å…¶ä»–èµ„æº
        window.addEventListener('DOMContentLoaded', function() {
            // æ£€æŸ¥ Monaco Editor CSS
            var monacoCSS = document.querySelector('link[href*="monaco-editor"]');
            if (monacoCSS && monacoCSS.sheet) {
                console.log('%câœ… Monaco Editor CSS åŠ è½½æˆåŠŸ', 'color: #10b981; font-weight: bold;');
            } else {
                console.log('%câš ï¸ Monaco Editor CSS å¯èƒ½æœªåŠ è½½', 'color: #f59e0b; font-weight: bold;');
            }
            
            // æ£€æŸ¥å­—ä½“ CSS å˜é‡
            var fontMono = getComputedStyle(document.documentElement).getPropertyValue('--font-mono');
            var fontSans = getComputedStyle(document.documentElement).getPropertyValue('--font-sans');
            if (fontMono && fontSans) {
                console.log('%câœ… ç³»ç»Ÿå­—ä½“å˜é‡å·²è®¾ç½®', 'color: #10b981; font-weight: bold;');
                console.log('   --font-mono:', fontMono.trim().substring(0, 50) + '...');
                console.log('   --font-sans:', fontSans.trim().substring(0, 50) + '...');
            } else {
                console.log('%câš ï¸ å­—ä½“å˜é‡æœªè®¾ç½®', 'color: #f59e0b; font-weight: bold;');
            }
        });
        
        // Monaco Editor åŠ è½½å®Œæˆåæ£€æŸ¥
        window.addEventListener('load', function() {
            setTimeout(function() {
                if (typeof monaco !== 'undefined') {
                    console.log('%câœ… Monaco Editor JS åŠ è½½æˆåŠŸ', 'color: #10b981; font-weight: bold;');
                } else {
                    console.log('%câŒ Monaco Editor JS åŠ è½½å¤±è´¥', 'color: #ef4444; font-weight: bold;');
                }
                console.log('%c====================================================', 'color: #3b82f6; font-weight: bold;');
            }, 1000);
        });
    </script>
    
    <style>
        :root {
            --bg-primary: #0a0e17;
            --bg-secondary: #111827;
            --bg-tertiary: #1a2234;
            --bg-card: #1e293b;
            --bg-hover: #2a3a52;
            --border-color: #2d3a4f;
            --border-active: #3b82f6;
            --text-primary: #f1f5f9;
            --text-secondary: #94a3b8;
            --text-muted: #64748b;
            --accent-blue: #3b82f6;
            --accent-cyan: #06b6d4;
            --accent-green: #10b981;
            --accent-red: #ef4444;
            --accent-yellow: #f59e0b;
            --accent-purple: #8b5cf6;
            --gradient-primary: linear-gradient(135deg, #3b82f6 0%, #8b5cf6 100%);
            --gradient-success: linear-gradient(135deg, #10b981 0%, #06b6d4 100%);
            --shadow-lg: 0 10px 40px rgba(0, 0, 0, 0.4);
            --shadow-glow: 0 0 20px rgba(59, 130, 246, 0.3);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: var(--font-sans);
            background: var(--bg-primary);
            color: var(--text-primary);
            height: 100vh;
            overflow: hidden;
        }

        /* Header */
        .header {
            height: 56px;
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 20px;
        }

        .header-left { display: flex; align-items: center; gap: 12px; }

        .logo {
            width: 36px; height: 36px;
            background: var(--gradient-primary);
            border-radius: 10px;
            display: flex; align-items: center; justify-content: center;
            font-size: 20px;
        }

        .app-title {
            font-size: 18px; font-weight: 600;
            background: var(--gradient-primary);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .header-right { display: flex; align-items: center; gap: 12px; }

        .status-indicator {
            display: flex; align-items: center; gap: 8px;
            padding: 6px 14px;
            background: var(--bg-tertiary);
            border-radius: 20px; font-size: 13px;
        }

        .status-dot {
            width: 8px; height: 8px; border-radius: 50%;
            background: var(--accent-green);
            animation: pulse 2s infinite;
        }
        .status-dot.offline { background: var(--text-muted); animation: none; }
        .status-dot.running { background: var(--accent-yellow); }

        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }

        .btn-icon {
            width: 36px; height: 36px; border: none;
            background: var(--bg-tertiary); border-radius: 8px;
            color: var(--text-secondary); cursor: pointer;
            display: flex; align-items: center; justify-content: center;
            font-size: 18px; transition: all 0.2s;
        }
        .btn-icon:hover { background: var(--bg-hover); color: var(--text-primary); }

        /* Workspace Button & Name */
        .workspace-btn { margin-right: 8px; }
        .workspace-name {
            margin-left: 12px; padding: 4px 12px;
            background: var(--bg-tertiary); border-radius: 6px;
            font-size: 13px; color: var(--text-secondary);
            max-width: 200px; overflow: hidden;
            text-overflow: ellipsis; white-space: nowrap;
        }

        /* Workspace Sidebar */
        .workspace-sidebar {
            position: fixed; top: 0; left: -320px;
            width: 320px; height: 100vh;
            background: var(--bg-secondary);
            border-right: 1px solid var(--border-color);
            z-index: 1001; transition: left 0.3s ease;
            display: flex; flex-direction: column;
        }
        .workspace-sidebar.open { left: 0; }
        
        .sidebar-overlay {
            position: fixed; top: 0; left: 0;
            width: 100vw; height: 100vh;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000; opacity: 0;
            visibility: hidden; transition: all 0.3s;
        }
        .sidebar-overlay.open { opacity: 1; visibility: visible; }

        .sidebar-header {
            padding: 16px 20px; display: flex;
            justify-content: space-between; align-items: center;
            border-bottom: 1px solid var(--border-color);
            background: var(--bg-tertiary);
        }
        .sidebar-header h3 { font-size: 16px; font-weight: 600; margin: 0; }

        .sidebar-actions { padding: 16px; border-bottom: 1px solid var(--border-color); }
        .sidebar-actions .btn { width: 100%; justify-content: center; }

        .workspace-list { flex: 1; overflow-y: auto; padding: 12px; }

        .workspace-item {
            padding: 14px 16px; margin-bottom: 8px;
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 10px; cursor: pointer;
            transition: all 0.2s;
        }
        .workspace-item:hover { border-color: var(--accent-blue); background: var(--bg-hover); }
        .workspace-item.active { border-color: var(--accent-blue); background: rgba(59, 130, 246, 0.1); }

        .workspace-item-header { display: flex; justify-content: space-between; align-items: center; }
        .workspace-item-name { font-size: 14px; font-weight: 500; color: var(--text-primary); }
        .workspace-item-meta { font-size: 11px; color: var(--text-muted); margin-top: 6px; }
        .workspace-item-actions { display: flex; gap: 4px; }
        .workspace-item-actions button {
            width: 24px; height: 24px; border: none;
            background: transparent; color: var(--text-muted);
            border-radius: 4px; cursor: pointer; font-size: 12px;
        }
        .workspace-item-actions button:hover { background: var(--bg-tertiary); color: var(--text-primary); }
        .workspace-item-actions button.delete:hover { color: var(--accent-red); }

        /* Main Layout */
        .main-container { display: flex; height: calc(100vh - 56px); }

        .panel {
            display: flex; flex-direction: column;
            background: var(--bg-secondary);
            border-right: 1px solid var(--border-color);
        }
        .panel:last-child { border-right: none; }

        .panel-header {
            height: 48px; padding: 0 16px;
            display: flex; align-items: center; justify-content: space-between;
            border-bottom: 1px solid var(--border-color);
            background: var(--bg-tertiary);
        }

        .panel-title {
            font-size: 14px; font-weight: 600;
            display: flex; align-items: center; gap: 8px;
        }

        .panel-content {
            flex: 1; overflow: hidden;
            display: flex; flex-direction: column;
        }

        /* Left Panel - Code Editor */
        .panel-code { width: 35%; min-width: 400px; }

        .editor-tabs {
            display: flex;
            background: var(--bg-tertiary);
            border-bottom: 1px solid var(--border-color);
        }

        .editor-tab {
            padding: 10px 16px; font-size: 13px;
            color: var(--text-secondary); cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all 0.2s;
        }
        .editor-tab:hover { color: var(--text-primary); background: var(--bg-hover); }
        .editor-tab.active { color: var(--accent-blue); border-bottom-color: var(--accent-blue); }

        #editor-container, #diff-container { flex: 1; min-height: 0; }

        .editor-actions {
            display: flex; gap: 8px; padding: 12px;
            background: var(--bg-tertiary);
            border-top: 1px solid var(--border-color);
        }

        .btn {
            padding: 8px 16px; border: none; border-radius: 6px;
            font-size: 13px; font-weight: 500; cursor: pointer;
            display: flex; align-items: center; gap: 6px;
            transition: all 0.2s;
        }
        .btn-primary { background: var(--gradient-primary); color: white; }
        .btn-primary:hover { transform: translateY(-1px); box-shadow: var(--shadow-glow); }
        .btn-secondary { background: var(--bg-card); color: var(--text-primary); border: 1px solid var(--border-color); }
        .btn-secondary:hover { background: var(--bg-hover); }
        .btn-success { background: #10b981; color: white; border: none; }
        .btn-success:hover { background: #059669; }
        .btn-danger { background: #ef4444; color: white; border: none; }
        .btn-danger:hover { background: #dc2626; }
        .btn-warning { background: #f59e0b; color: white; border: none; }
        .btn-warning:hover { background: #d97706; }
        .btn-xs { padding: 4px 8px; font-size: 11px; }
        .tab-actions { padding: 8px 12px; display: flex; justify-content: flex-end; border-bottom: 1px solid var(--border-color); }
        .delete-btn { opacity: 0; transition: opacity 0.2s; padding: 2px 6px; font-size: 11px; background: transparent; color: #ef4444; border: none; cursor: pointer; }
        .report-item:hover .delete-btn, .history-item:hover .delete-btn { opacity: 1; }
        .delete-btn:hover { background: rgba(239, 68, 68, 0.2); border-radius: 4px; }
        .btn-success { background: var(--gradient-success); color: white; }
        .btn-sm { padding: 6px 12px; font-size: 12px; }

        /* Center Panel - Chat */
        .panel-chat { width: 35%; min-width: 380px; }

        .chat-messages {
            flex: 1; overflow-y: auto; padding: 16px;
            display: flex; flex-direction: column; gap: 16px;
        }

        .message { max-width: 90%; animation: fadeIn 0.3s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .message-user { align-self: flex-end; }
        .message-ai { align-self: flex-start; }

        .message-content {
            padding: 12px 16px; border-radius: 12px;
            font-size: 14px; line-height: 1.6;
        }
        .message-user .message-content {
            background: var(--gradient-primary); color: white;
            border-bottom-right-radius: 4px;
        }
        .message-ai .message-content {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-bottom-left-radius: 4px;
        }
        .message-ai .message-content code {
            background: var(--bg-tertiary);
            padding: 2px 6px; border-radius: 4px;
            font-family: var(--font-mono); font-size: 13px;
        }
        .message-ai .message-content pre {
            background: var(--bg-primary);
            padding: 12px; border-radius: 8px;
            overflow-x: auto; margin: 12px 0;
        }
        .message-ai .message-content pre code { background: none; padding: 0; }
        
        /* ç²¾ç¡®ç¼–è¾‘æ¨¡å¼çŠ¶æ€æç¤º */
        .edit-status-badge {
            display: inline-flex; align-items: center; gap: 8px;
            padding: 8px 14px; margin: 12px 0;
            background: rgba(16, 185, 129, 0.15);
            border: 1px solid rgba(16, 185, 129, 0.3);
            border-radius: 8px; color: var(--accent-green);
            font-size: 13px; font-weight: 500;
        }
        .edit-status-badge.warning {
            background: rgba(245, 158, 11, 0.15);
            border-color: rgba(245, 158, 11, 0.3);
            color: var(--accent-yellow);
        }
        .edit-status-badge .icon { font-size: 16px; }

        .message-actions { display: flex; gap: 8px; margin-top: 8px; }

        .message-action-btn {
            padding: 4px 10px; font-size: 12px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 4px; color: var(--text-secondary);
            cursor: pointer; transition: all 0.2s;
        }
        .message-action-btn:hover { background: var(--bg-hover); color: var(--text-primary); }

        /* AIæ“ä½œæŒ‰é’® */
        .ai-action-btn {
            display: inline-flex; align-items: center; gap: 6px;
            padding: 8px 16px; font-size: 13px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 8px; color: var(--text-primary);
            cursor: pointer; transition: all 0.2s;
        }
        .ai-action-btn:hover { background: var(--bg-hover); border-color: var(--accent-blue); }
        .ai-action-btn.primary {
            background: var(--accent-blue); border-color: var(--accent-blue); color: white;
        }
        .ai-action-btn.primary:hover { background: #2563eb; }
        .ai-action-btn.danger { background: var(--accent-red); border-color: var(--accent-red); color: white; }
        .ai-action-btn.danger:hover { background: #dc2626; }

        .welcome-message { text-align: center; padding: 60px 30px; }
        .welcome-icon {
            width: 80px; height: 80px;
            background: var(--gradient-primary);
            border-radius: 20px;
            display: flex; align-items: center; justify-content: center;
            font-size: 40px; margin: 0 auto 24px;
            box-shadow: var(--shadow-glow);
        }
        .welcome-title { font-size: 22px; font-weight: 600; margin-bottom: 12px; }
        .welcome-subtitle { color: var(--text-secondary); font-size: 14px; margin-bottom: 30px; }
        .welcome-features { text-align: left; max-width: 280px; margin: 0 auto; }
        .welcome-feature { display: flex; align-items: center; gap: 12px; padding: 10px 0; color: var(--text-secondary); font-size: 14px; }
        .welcome-feature-icon { width: 32px; height: 32px; background: var(--bg-card); border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 16px; }

        /* Chat Input */
        .chat-input-area {
            padding: 16px;
            background: var(--bg-tertiary);
            border-top: 1px solid var(--border-color);
        }

        .auto-toggles { display: flex; gap: 12px; margin-bottom: 12px; flex-wrap: wrap; }

        .toggle-item {
            display: flex; align-items: center; gap: 8px;
            padding: 6px 12px; background: var(--bg-card);
            border-radius: 20px; font-size: 12px;
            cursor: pointer; transition: all 0.2s;
            border: 1px solid var(--border-color);
        }
        .toggle-item:hover { border-color: var(--accent-blue); }
        .toggle-item.active {
            background: rgba(59, 130, 246, 0.2);
            border-color: var(--accent-blue);
            color: var(--accent-blue);
        }

        .toggle-switch {
            width: 28px; height: 16px;
            background: var(--bg-tertiary);
            border-radius: 8px; position: relative;
            transition: all 0.2s;
        }
        .toggle-item.active .toggle-switch { background: var(--accent-blue); }
        .toggle-switch::after {
            content: ''; width: 12px; height: 12px;
            background: white; border-radius: 50%;
            position: absolute; top: 2px; left: 2px;
            transition: all 0.2s;
        }
        .toggle-item.active .toggle-switch::after { left: 14px; }

        .chat-input-wrapper { display: flex; gap: 10px; align-items: flex-end; }

        .chat-input {
            flex: 1; min-height: 44px; max-height: 150px;
            padding: 12px 16px; background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 12px; color: var(--text-primary);
            font-size: 14px; resize: none;
            font-family: inherit; line-height: 1.5;
        }
        .chat-input:focus { outline: none; border-color: var(--accent-blue); box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1); }
        .chat-input::placeholder { color: var(--text-muted); }

        .send-btn {
            width: 44px; height: 44px; border: none;
            background: var(--gradient-primary);
            border-radius: 12px; color: white; cursor: pointer;
            display: flex; align-items: center; justify-content: center;
            font-size: 20px; transition: all 0.2s; flex-shrink: 0;
        }
        .send-btn:hover { transform: translateY(-2px); box-shadow: var(--shadow-glow); }
        .send-btn:disabled { background: var(--bg-card); cursor: not-allowed; transform: none; box-shadow: none; }

        .scroll-to-bottom-btn {
            position: absolute; bottom: 140px; left: 50%; transform: translateX(-50%);
            width: 36px; height: 36px; border-radius: 50%;
            background: var(--bg-card); border: 1px solid var(--border-color);
            color: var(--text-primary); cursor: pointer;
            display: flex; align-items: center; justify-content: center;
            font-size: 18px; transition: all 0.2s;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3); z-index: 10;
        }
        .scroll-to-bottom-btn:hover {
            background: var(--bg-hover); border-color: var(--accent-primary);
            transform: translateX(-50%) scale(1.1);
        }

        .stop-btn-container {
            display: flex; justify-content: center; margin-bottom: 12px;
        }
        .stop-btn {
            display: flex; align-items: center; gap: 8px;
            padding: 8px 20px; border: 1px solid var(--border-color);
            background: var(--bg-card);
            border-radius: 20px; color: var(--text-primary); cursor: pointer;
            font-size: 13px; transition: all 0.2s;
        }
        .stop-btn:hover { background: var(--bg-hover); border-color: var(--accent-red); }
        .stop-btn .stop-icon { 
            color: var(--accent-red); font-size: 10px;
        }

        /* Right Panel */
        .panel-right { width: 30%; min-width: 320px; }

        .right-tabs { display: flex; background: var(--bg-tertiary); }
        .right-tab {
            flex: 1; padding: 12px; text-align: center;
            font-size: 13px; color: var(--text-secondary);
            cursor: pointer; border-bottom: 2px solid transparent;
            transition: all 0.2s;
        }
        .right-tab:hover { color: var(--text-primary); }
        .right-tab.active { color: var(--accent-blue); border-bottom-color: var(--accent-blue); }

        .right-content { flex: 1; overflow-y: auto; padding: 16px; }
        .tab-pane { display: none; }
        .tab-pane.active { display: block; }

        /* Report List */
        .report-list { display: flex; flex-direction: column; gap: 8px; }
        .report-item {
            padding: 12px; background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 8px; cursor: pointer;
            transition: all 0.2s;
            display: flex; justify-content: space-between; align-items: center;
        }
        .report-item:hover { border-color: var(--accent-blue); background: var(--bg-hover); }
        .report-item-content { flex: 1; }
        .report-item-name { font-size: 13px; color: var(--text-primary); margin-bottom: 4px; word-break: break-all; }
        .report-item-time { font-size: 11px; color: var(--text-muted); }

        .no-data { text-align: center; padding: 40px 20px; color: var(--text-muted); }
        .no-data-icon { font-size: 48px; margin-bottom: 16px; }

        /* History */
        .history-list { display: flex; flex-direction: column; gap: 8px; }
        .history-item {
            padding: 12px; background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 8px; transition: all 0.2s;
        }
        .history-item:hover { border-color: var(--accent-blue); }
        .history-item-header { display: flex; align-items: center; margin-bottom: 6px; gap: 8px; }
        .history-item-time { font-size: 12px; color: var(--text-muted); flex-shrink: 0; }
        .history-item-badge { padding: 2px 8px; background: var(--accent-green); border-radius: 4px; font-size: 10px; color: white; flex-shrink: 0; text-align: center; min-width: 32px; }
        .history-item-name { font-size: 13px; color: var(--text-secondary); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .history-item-actions { display: flex; gap: 6px; margin-top: 8px; }
        .auto-save-tag { background: var(--accent-yellow); color: #000; padding: 2px 6px; border-radius: 4px; font-size: 10px; margin-left: 6px; }

        /* Settings */
        .settings-section { margin-bottom: 24px; }
        .settings-section-title {
            font-size: 14px; font-weight: 600;
            color: var(--accent-cyan);
            margin-bottom: 12px;
            display: flex; align-items: center; gap: 8px;
        }
        .settings-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        .settings-item { display: flex; flex-direction: column; gap: 6px; }
        .settings-item.full-width { grid-column: span 2; }
        .settings-label { font-size: 12px; color: var(--text-muted); }
        .settings-input, .settings-select {
            padding: 10px 12px; background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 6px; color: var(--text-primary); font-size: 13px;
        }
        .settings-input:focus, .settings-select:focus { outline: none; border-color: var(--accent-blue); }

        .backtest-params { background: var(--bg-card); border-radius: 8px; padding: 16px; border: 1px solid var(--border-color); }

        /* Data Sources */
        .data-sources-section { margin-top: 16px; }
        .data-sources-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
        .data-sources-title { font-size: 13px; font-weight: 600; color: var(--text-primary); }
        .btn-add-source {
            padding: 6px 12px; background: var(--accent-green); color: white;
            border: none; border-radius: 6px; font-size: 12px; cursor: pointer;
        }
        .btn-add-source:hover { background: #16a34a; }
        .data-source-card {
            background: var(--bg-primary); border: 1px solid var(--border-color);
            border-radius: 8px; padding: 12px; margin-bottom: 10px;
        }
        .data-source-header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 10px; padding-bottom: 8px; border-bottom: 1px solid var(--border-color);
        }
        .data-source-index { 
            font-size: 12px; font-weight: 600; color: var(--accent-blue);
            background: rgba(59,130,246,0.1); padding: 2px 8px; border-radius: 4px;
        }
        .btn-remove-source {
            padding: 4px 8px; background: var(--accent-red); color: white;
            border: none; border-radius: 4px; font-size: 11px; cursor: pointer;
        }
        .btn-remove-source:hover { background: #dc2626; }
        .data-source-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; }
        .data-source-item { display: flex; flex-direction: column; gap: 4px; }
        .data-source-item label { font-size: 11px; color: var(--text-muted); }
        .data-source-item input, .data-source-item select {
            padding: 6px 8px; background: var(--bg-card); border: 1px solid var(--border-color);
            border-radius: 4px; color: var(--text-primary); font-size: 12px;
        }

        /* Run Log */
        .run-log {
            background: var(--bg-primary); border-radius: 8px;
            padding: 12px; font-family: var(--font-mono);
            font-size: 12px; max-height: 200px; overflow-y: auto;
            margin-top: 16px;
        }
        .log-line { padding: 2px 0; color: var(--text-secondary); }
        .log-line.info { color: var(--accent-blue); }
        .log-line.success { color: var(--accent-green); }
        .log-line.error { color: var(--accent-red); }
        .log-line.warning { color: var(--accent-yellow); }

        /* Modal */
        .modal-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: flex; align-items: center; justify-content: center;
            z-index: 1000; opacity: 0; visibility: hidden;
            transition: all 0.3s;
        }
        .modal-overlay.active { opacity: 1; visibility: visible; }

        .modal {
            background: var(--bg-secondary);
            border-radius: 16px; width: 90%;
            max-height: 90vh; overflow: hidden;
            transform: scale(0.9); transition: all 0.3s;
            display: flex; flex-direction: column;
        }
        .modal-overlay.active .modal { transform: scale(1); }
        .modal-sm { max-width: 500px; }
        .modal-md { max-width: 700px; }
        .modal-lg { max-width: 1200px; }
        .modal-xl { max-width: 95%; height: 90vh; }

        .modal-header {
            padding: 20px;
            border-bottom: 1px solid var(--border-color);
            display: flex; align-items: center; justify-content: space-between;
            flex-shrink: 0;
        }
        .modal-title { font-size: 18px; font-weight: 600; }
        .modal-close {
            width: 32px; height: 32px; border: none;
            background: var(--bg-card); border-radius: 8px;
            color: var(--text-secondary); cursor: pointer; font-size: 18px;
        }
        .modal-close:hover { background: var(--bg-hover); color: var(--text-primary); }

        .modal-content {
            padding: 20px; overflow-y: auto;
            flex: 1; min-height: 0;
        }
        .modal-content.no-padding { padding: 0; }

        .modal-footer {
            padding: 16px 20px;
            border-top: 1px solid var(--border-color);
            display: flex; justify-content: flex-end; gap: 10px;
            flex-shrink: 0;
        }

        /* Loading */
        .loading-spinner {
            display: inline-block; width: 16px; height: 16px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-top-color: white; border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* Typing Indicator */
        .typing-indicator {
            display: flex; gap: 4px; padding: 12px 16px;
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 12px; border-bottom-left-radius: 4px;
            width: fit-content;
        }
        .typing-dot {
            width: 8px; height: 8px;
            background: var(--text-muted);
            border-radius: 50%;
            animation: typingBounce 1.4s infinite ease-in-out;
        }
        .typing-dot:nth-child(1) { animation-delay: -0.32s; }
        .typing-dot:nth-child(2) { animation-delay: -0.16s; }
        @keyframes typingBounce {
            0%, 80%, 100% { transform: scale(0.8); opacity: 0.5; }
            40% { transform: scale(1); opacity: 1; }
        }

        /* Scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: var(--bg-primary); }
        ::-webkit-scrollbar-thumb { background: var(--border-color); border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--text-muted); }

        /* Toast */
        .toast {
            position: fixed; bottom: 20px; left: 50%;
            transform: translateX(-50%);
            padding: 12px 24px; border-radius: 8px;
            font-size: 14px; z-index: 9999;
            animation: fadeIn 0.3s ease;
        }
        .toast-success { background: var(--accent-green); color: white; }
        .toast-error { background: var(--accent-red); color: white; }

        /* Strategy Mode Tabs */
        .mode-tabs { display: flex; gap: 8px; margin-bottom: 16px; }
        .mode-tab {
            padding: 8px 16px; font-size: 12px;
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 6px; cursor: pointer;
            transition: all 0.2s;
        }
        .mode-tab:hover { border-color: var(--accent-blue); }
        .mode-tab.active {
            background: var(--accent-blue);
            border-color: var(--accent-blue);
            color: white;
        }

        .mode-content { display: none; }
        .mode-content.active { display: block; }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="header-left">
            <button class="btn-icon workspace-btn" onclick="toggleWorkspaceSidebar()" title="å·¥ä½œåŒº">â˜°</button>
            <div class="logo">ğŸ¿ï¸</div>
            <span class="app-title">SSQuant AI Agent</span>
            <span class="workspace-name" id="currentWorkspaceName" title="ç‚¹å‡»å·¦ä¾§èœå•é€‰æ‹©æˆ–åˆ›å»ºå·¥ä½œåŒº">å…¨éƒ¨æ•°æ®</span>
        </div>
        <div class="header-right">
            <div class="status-indicator">
                <span class="status-dot" id="statusDot"></span>
                <span id="statusText">å°±ç»ª</span>
            </div>
            <button class="btn-icon" onclick="openSettingsModal()" title="è®¾ç½®">âš™ï¸</button>
            <button class="btn-icon" onclick="openExamplesModal()" title="ç¤ºä¾‹ç­–ç•¥">ğŸ“š</button>
        </div>
    </header>

    <!-- Workspace Sidebar -->
    <div class="workspace-sidebar" id="workspaceSidebar">
        <div class="sidebar-header">
            <h3>ğŸ“ å·¥ä½œåŒº</h3>
            <button class="btn-icon" onclick="toggleWorkspaceSidebar()">Ã—</button>
        </div>
        <div class="sidebar-actions">
            <button class="btn btn-primary btn-sm" onclick="createNewWorkspace()">
                <span>+</span> æ–°å»ºå·¥ä½œåŒº
            </button>
        </div>
        <div class="workspace-list" id="workspaceList">
            <div class="no-data">
                <p>æš‚æ— å·¥ä½œåŒº</p>
            </div>
        </div>
    </div>
    <div class="sidebar-overlay" id="sidebarOverlay" onclick="toggleWorkspaceSidebar()"></div>

    <!-- Main Container -->
    <div class="main-container">
        <!-- Left Panel - Code Editor -->
        <div class="panel panel-code">
            <div class="panel-header">
                <span class="panel-title">ğŸ“ ç­–ç•¥ä»£ç </span>
                <button class="btn btn-secondary btn-sm" onclick="copyCode()">ğŸ“‹ å¤åˆ¶</button>
            </div>
            <div class="panel-content">
                <div class="editor-tabs">
                    <div class="editor-tab active" data-tab="editor" onclick="switchEditorTab('editor')">ç¼–è¾‘å™¨</div>
                    <div class="editor-tab" data-tab="diff" onclick="switchEditorTab('diff')">å·®å¼‚å¯¹æ¯”</div>
                </div>
                <div id="editor-container"></div>
                <div id="diff-container" style="display: none;"></div>
                <div class="editor-actions">
                    <button class="btn btn-success" onclick="runBacktest()">â–¶ï¸ è¿è¡Œå›æµ‹</button>
                    <button class="btn btn-secondary" onclick="saveStrategy()">ğŸ’¾ ä¿å­˜ç‰ˆæœ¬</button>
                </div>
            </div>
        </div>

        <!-- Center Panel - AI Chat -->
        <div class="panel panel-chat">
            <div class="panel-header">
                <span class="panel-title">ğŸ¤– AI åŠ©æ‰‹</span>
                <button class="btn btn-secondary btn-sm" onclick="clearChat()">ğŸ—‘ï¸ æ¸…ç©º</button>
            </div>
            <div class="panel-content" style="position: relative;">
                <div class="chat-messages" id="chatMessages">
                    <div class="welcome-message" id="welcomeMessage">
                        <div class="welcome-icon">ğŸ¤–</div>
                        <h2 class="welcome-title">æ¬¢è¿ä½¿ç”¨ SSQuant AI Agent</h2>
                        <p class="welcome-subtitle">è¾“å…¥ä½ çš„éœ€æ±‚ï¼Œæˆ‘å¯ä»¥å¸®ä½ ï¼š</p>
                        <div class="welcome-features">
                            <div class="welcome-feature"><span class="welcome-feature-icon">ğŸ“</span><span>ç”Ÿæˆé‡åŒ–äº¤æ˜“ç­–ç•¥ä»£ç </span></div>
                            <div class="welcome-feature"><span class="welcome-feature-icon">ğŸ“Š</span><span>è‡ªåŠ¨å›æµ‹å¹¶åˆ†æç»“æœ</span></div>
                            <div class="welcome-feature"><span class="welcome-feature-icon">ğŸ”§</span><span>è°ƒè¯•å’Œä¼˜åŒ–ç­–ç•¥</span></div>
                            <div class="welcome-feature"><span class="welcome-feature-icon">ğŸ’¡</span><span>è§£ç­”é‡åŒ–äº¤æ˜“é—®é¢˜</span></div>
                        </div>
                    </div>
                </div>

                <div class="chat-input-area">
                    <div class="auto-toggles">
                        <div class="toggle-item" id="toggleBacktest" onclick="toggleAuto('backtest')">
                            <span class="toggle-switch"></span><span>è‡ªåŠ¨å›æµ‹</span>
                        </div>
                        <div class="toggle-item" id="toggleDebug" onclick="toggleAuto('debug')">
                            <span class="toggle-switch"></span><span>è‡ªåŠ¨è°ƒè¯•</span>
                        </div>
                        <div class="toggle-item" id="toggleIterate" onclick="toggleAuto('iterate')">
                            <span class="toggle-switch"></span><span>è‡ªåŠ¨è¿­ä»£</span>
                        </div>
                    </div>
                    <!-- æ»šåŠ¨åˆ°åº•éƒ¨æŒ‰é’® -->
                    <button class="scroll-to-bottom-btn" id="scrollToBottomBtn" onclick="scrollToBottom()" style="display: none;">
                        <span>â†“</span>
                    </button>
                    <div class="stop-btn-container" id="stopBtnContainer" style="display: none;">
                        <button class="stop-btn" id="stopBtn" onclick="stopGeneration()">
                            <span class="stop-icon">â– </span>
                            <span>åœæ­¢ç”Ÿæˆ</span>
                        </button>
                    </div>
                    <div class="chat-input-wrapper">
                        <textarea class="chat-input" id="chatInput" 
                                  placeholder="è¾“å…¥ä½ çš„éœ€æ±‚ï¼Œä¾‹å¦‚ï¼šç»™æˆ‘ä¸€ä¸ªåŒå‡çº¿ç­–ç•¥" rows="1"></textarea>
                        <button class="send-btn" id="sendBtn" onclick="sendMessage()">â¤</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Right Panel -->
        <div class="panel panel-right">
 
            <div class="panel-content">
                <div class="right-tabs">
                    <div class="right-tab active" data-tab="report" onclick="switchRightTab('report')">æŠ¥å‘Š</div>
                    <div class="right-tab" data-tab="history" onclick="switchRightTab('history')">å†å²</div>
                    <div class="right-tab" data-tab="params" onclick="switchRightTab('params')">å‚æ•°åŠè¿è¡Œæ—¥å¿—</div>
                </div>
                <div class="right-content">
                    <!-- Report Tab -->
                    <div class="tab-pane active" id="tabReport">
                        <div class="tab-actions" id="reportActions" style="display: none;">
                            <button class="btn btn-danger btn-xs" onclick="clearAllReports()">ğŸ—‘ï¸ æ¸…ç©ºå…¨éƒ¨</button>
                        </div>
                        <div class="report-list" id="reportList">
                            <div class="no-data">
                                <div class="no-data-icon">ğŸ“ˆ</div>
                                <p>æš‚æ— å›æµ‹æŠ¥å‘Š</p>
                            </div>
                        </div>
                    </div>

                    <!-- History Tab -->
                    <div class="tab-pane" id="tabHistory">
                        <div class="tab-actions" id="historyActions" style="display: none;">
                            <button class="btn btn-danger btn-xs" onclick="clearAllHistory()">ğŸ—‘ï¸ æ¸…ç©ºå…¨éƒ¨</button>
                        </div>
                        <div class="history-list" id="historyList"></div>
                    </div>

                    <!-- Params Tab -->
                    <div class="tab-pane" id="tabParams">
                        <div class="settings-section">
                            <div class="settings-section-title">ğŸ“Š å›æµ‹å‚æ•°</div>
                            
                            <!-- Strategy Mode -->
                            <div class="mode-tabs">
                                <div class="mode-tab active" data-mode="single" onclick="switchStrategyMode('single')">å•å“ç§</div>
                                <div class="mode-tab" data-mode="multi" onclick="switchStrategyMode('multi')">å¤šå“ç§/è·¨å‘¨æœŸ</div>
                                <div class="mode-tab" data-mode="tick" onclick="switchStrategyMode('tick')">TICKé«˜é¢‘</div>
                            </div>

                            <!-- Single Mode -->
                            <div class="mode-content active" id="modeSingle">
                                <div class="backtest-params">
                                    <div class="settings-grid">
                                        <div class="settings-item">
                                            <label class="settings-label">åˆçº¦ä»£ç </label>
                                            <input type="text" class="settings-input" id="paramSymbol" value="rb888" placeholder="å¦‚rb888">
                                        </div>
                                        <div class="settings-item">
                                            <label class="settings-label">Kçº¿å‘¨æœŸ</label>
                                            <select class="settings-select" id="paramPeriod">
                                                <option value="1m">1åˆ†é’Ÿ</option>
                                                <option value="5m" selected>5åˆ†é’Ÿ</option>
                                                <option value="15m">15åˆ†é’Ÿ</option>
                                                <option value="30m">30åˆ†é’Ÿ</option>
                                                <option value="1h">1å°æ—¶</option>
                                                <option value="1d">æ—¥çº¿</option>
                                            </select>
                                        </div>
                                        <div class="settings-item">
                                            <label class="settings-label">å¼€å§‹æ—¥æœŸ</label>
                                            <input type="date" class="settings-input" id="paramStartDate" value="2025-12-01">
                                        </div>
                                        <div class="settings-item">
                                            <label class="settings-label">ç»“æŸæ—¥æœŸ</label>
                                            <input type="date" class="settings-input" id="paramEndDate" value="2026-01-31">
                                        </div>
                                        <div class="settings-item">
                                            <label class="settings-label">åˆå§‹èµ„é‡‘</label>
                                            <input type="number" class="settings-input" id="paramCapital" value="1000000">
                                        </div>
                                        <div class="settings-item">
                                            <label class="settings-label">æ‰‹ç»­è´¹ç‡</label>
                                            <input type="text" class="settings-input" id="paramCommission" value="0.0001">
                                        </div>
                                        <div class="settings-item">
                                            <label class="settings-label">ä¿è¯é‡‘ç‡</label>
                                            <input type="text" class="settings-input" id="paramMargin" value="0.1">
                                        </div>
                                        <div class="settings-item">
                                            <label class="settings-label">åˆçº¦ä¹˜æ•°</label>
                                            <input type="number" class="settings-input" id="paramMultiplier" value="10">
                                        </div>
                                        <div class="settings-item">
                                            <label class="settings-label">æœ€å°å˜åŠ¨ä»·ä½</label>
                                            <input type="text" class="settings-input" id="paramPriceTick" value="1">
                                        </div>
                                        <div class="settings-item">
                                            <label class="settings-label">æ»‘ç‚¹è·³æ•°</label>
                                            <input type="number" class="settings-input" id="paramSlippage" value="1">
                                        </div>
                                        <div class="settings-item">
                                            <label class="settings-label">å¤æƒç±»å‹</label>
                                            <select class="settings-select" id="paramAdjust">
                                                <option value="0">ä¸å¤æƒ</option>
                                                <option value="1" selected>åå¤æƒ</option>
                                            </select>
                                        </div>
                                        <div class="settings-item">
                                            <label class="settings-label">å›æº¯çª—å£</label>
                                            <input type="number" class="settings-input" id="paramLookback" value="500">
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Multi Mode -->
                            <div class="mode-content" id="modeMulti">
                                <div class="backtest-params">
                                    <div class="settings-grid">
                                        <div class="settings-item">
                                            <label class="settings-label">å¼€å§‹æ—¥æœŸ</label>
                                            <input type="date" class="settings-input" id="paramMultiStartDate" value="2025-12-01">
                                        </div>
                                        <div class="settings-item">
                                            <label class="settings-label">ç»“æŸæ—¥æœŸ</label>
                                            <input type="date" class="settings-input" id="paramMultiEndDate" value="2026-01-31">
                                        </div>
                                        <div class="settings-item">
                                            <label class="settings-label">åˆå§‹èµ„é‡‘</label>
                                            <input type="number" class="settings-input" id="paramMultiCapital" value="1000000">
                                        </div>
                                        <div class="settings-item">
                                            <label class="settings-label">æ‰‹ç»­è´¹ç‡</label>
                                            <input type="text" class="settings-input" id="paramMultiCommission" value="0.0001">
                                        </div>
                                        <div class="settings-item">
                                            <label class="settings-label">ä¿è¯é‡‘ç‡</label>
                                            <input type="text" class="settings-input" id="paramMultiMargin" value="0.1">
                                        </div>
                                        <div class="settings-item">
                                            <label class="settings-label">å›æº¯çª—å£</label>
                                            <input type="number" class="settings-input" id="paramMultiLookback" value="500">
                                        </div>
                                        <div class="settings-item full-width">
                                            <label class="settings-label">æ•°æ®å¯¹é½ (å¥—åˆ©/è·¨å‘¨æœŸç­–ç•¥å¿…é¡»å¼€å¯)</label>
                                            <select class="settings-select" id="paramAlignData">
                                                <option value="false">å…³é—­ (ç‹¬ç«‹ç­–ç•¥)</option>
                                                <option value="true" selected>å¼€å¯ (å¥—åˆ©/è·¨å‘¨æœŸ)</option>
                                            </select>
                                        </div>
                                    </div>
                                    
                                    <!-- æ•°æ®æºé…ç½® -->
                                    <div class="data-sources-section">
                                        <div class="data-sources-header">
                                            <span class="data-sources-title">ğŸ“Š æ•°æ®æºé…ç½®</span>
                                            <button class="btn-add-source" onclick="addDataSource()">+ æ·»åŠ æ•°æ®æº</button>
                                        </div>
                                        <div class="data-sources-list" id="dataSourcesList">
                                            <!-- åŠ¨æ€ç”Ÿæˆæ•°æ®æº -->
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Tick Mode -->
                            <div class="mode-content" id="modeTick">
                                <div class="backtest-params">
                                    <div class="settings-grid">
                                        <div class="settings-item">
                                            <label class="settings-label">åˆçº¦ä»£ç </label>
                                            <input type="text" class="settings-input" id="paramTickSymbol" value="au888">
                                        </div>
                                        <div class="settings-item">
                                            <label class="settings-label">æ•°æ®ç±»å‹</label>
                                            <input type="text" class="settings-input" value="tick" disabled>
                                        </div>
                                        <div class="settings-item">
                                            <label class="settings-label">å¼€å§‹æ—¥æœŸ</label>
                                            <input type="date" class="settings-input" id="paramTickStartDate" value="2026-01-01">
                                        </div>
                                        <div class="settings-item">
                                            <label class="settings-label">ç»“æŸæ—¥æœŸ</label>
                                            <input type="date" class="settings-input" id="paramTickEndDate" value="2026-01-31">
                                        </div>
                                        <div class="settings-item">
                                            <label class="settings-label">æœ€å°å˜åŠ¨ä»·ä½</label>
                                            <input type="text" class="settings-input" id="paramTickPriceTick" value="0.02">
                                        </div>
                                        <div class="settings-item">
                                            <label class="settings-label">åˆçº¦ä¹˜æ•°</label>
                                            <input type="number" class="settings-input" id="paramTickMultiplier" value="1000">
                                        </div>
                                        <div class="settings-item">
                                            <label class="settings-label">æ»‘ç‚¹è·³æ•°</label>
                                            <input type="number" class="settings-input" id="paramTickSlippage" value="1">
                                        </div>
                                        <div class="settings-item">
                                            <label class="settings-label">å›æº¯çª—å£</label>
                                            <input type="number" class="settings-input" id="paramTickLookback" value="1000">
                                        </div>
                                    </div>
                                    <p style="font-size: 12px; color: var(--text-muted); margin-top: 12px;">
                                        âš ï¸ TICKæ•°æ®åªèƒ½ä»æœ¬åœ°æ•°æ®åº“è·å–ï¼Œéœ€å…ˆé‡‡é›†æ•°æ®
                                    </p>
                                </div>
                            </div>
                        </div>

                        <div class="settings-section">
                            <div class="settings-section-title">ğŸ“‹ è¿è¡Œæ—¥å¿—</div>
                            <div class="run-log" id="runLog">
                                <div class="log-line info">ç­‰å¾…å¯åŠ¨...</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div class="modal-overlay" id="settingsModal">
        <div class="modal modal-sm">
            <div class="modal-header">
                <span class="modal-title">âš™ï¸ LLM è®¾ç½®</span>
                <button class="modal-close" onclick="closeModal('settingsModal')">Ã—</button>
            </div>
            <div class="modal-content">
                <div class="settings-grid">
                    <div class="settings-item full-width">
                        <label class="settings-label">API æ¥å£åœ°å€ (æ”¯æŒ OpenAI å…¼å®¹æ ¼å¼)</label>
                        <input type="text" class="settings-input" id="settingBaseUrl" 
                               value="https://api.deepseek.com/v1" 
                               placeholder="ä¾‹å¦‚: https://api.openai.com/v1">
                        <small style="color: var(--text-muted); font-size: 11px; margin-top: 4px;">
                            æ”¯æŒ DeepSeekã€OpenAIã€Claudeã€é€šä¹‰åƒé—®ç­‰å…¼å®¹æ¥å£
                        </small>
                    </div>
                    <div class="settings-item">
                        <label class="settings-label">æ¨¡å‹åç§°</label>
                        <input type="text" class="settings-input" id="settingModel" value="deepseek-chat"
                               placeholder="ä¾‹å¦‚: gpt-4o, claude-3-opus">
                    </div>
                    <div class="settings-item">
                        <label class="settings-label">å¿«æ·é€‰æ‹©</label>
                        <select class="settings-select" id="settingProvider" onchange="onProviderChange()">
                            <option value="Custom">è‡ªå®šä¹‰</option>
                            <option value="DeepSeek">DeepSeek</option>
                            <option value="OpenAI">OpenAI</option>
                            <option value="Claude">Claude (API)</option>
                            <option value="Qwen">é€šä¹‰åƒé—®</option>
                            <option value="Moonshot">Moonshot</option>
                            <option value="Zhipu">æ™ºè°± GLM</option>
                        </select>
                    </div>
                    <div class="settings-item full-width">
                        <label class="settings-label">API Key</label>
                        <input type="password" class="settings-input" id="settingApiKey" placeholder="è¾“å…¥ä½ çš„API Key">
                    </div>
                    <div class="settings-item full-width">
                        <label class="settings-label">Temperature: <span id="tempValue">0.7</span></label>
                        <input type="range" class="settings-input" id="settingTemp" min="0" max="2" step="0.1" value="0.7"
                               oninput="document.getElementById('tempValue').textContent = this.value">
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="resetSettings()">æ¢å¤é»˜è®¤</button>
                <button class="btn btn-primary" onclick="saveSettings()">ä¿å­˜é…ç½®</button>
            </div>
        </div>
    </div>

    <!-- Examples Modal -->
    <div class="modal-overlay" id="examplesModal">
        <div class="modal modal-md">
            <div class="modal-header">
                <span class="modal-title">ğŸ“š ç¤ºä¾‹ç­–ç•¥</span>
                <button class="modal-close" onclick="closeModal('examplesModal')">Ã—</button>
            </div>
            <div class="modal-content">
                <div class="history-list" id="examplesList"></div>
            </div>
        </div>
    </div>

    <!-- Example Code Preview Modal -->
    <div class="modal-overlay" id="codePreviewModal">
        <div class="modal modal-xl">
            <div class="modal-header">
                <span class="modal-title" id="codePreviewTitle">ğŸ“ ä»£ç é¢„è§ˆ</span>
                <button class="modal-close" onclick="closeModal('codePreviewModal')">Ã—</button>
            </div>
            <div class="modal-content no-padding" style="height: calc(90vh - 140px);">
                <div id="codePreviewEditor" style="width: 100%; height: 100%;"></div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('codePreviewModal')">å…³é—­</button>
                <button class="btn btn-primary" onclick="applyPreviewCode()">åº”ç”¨åˆ°ç¼–è¾‘å™¨</button>
            </div>
        </div>
    </div>

    <!-- Report Preview Modal -->
    <div class="modal-overlay" id="reportModal">
        <div class="modal modal-xl">
            <div class="modal-header">
                <span class="modal-title" id="reportModalTitle">ğŸ“Š å›æµ‹æŠ¥å‘Š</span>
                <button class="modal-close" onclick="closeModal('reportModal')">Ã—</button>
            </div>
            <div class="modal-content no-padding" style="height: calc(90vh - 80px);">
                <iframe id="reportIframe" style="width: 100%; height: 100%; border: none;"></iframe>
            </div>
        </div>
    </div>

    <!-- Monaco Editor - æœ¬åœ°åŒ– -->
    <script src="/static/node_modules/monaco-editor/min/vs/loader.js"></script>
    
    <script>
        // ==================== å…¨å±€å˜é‡ ====================
        let editor = null;
        let diffEditor = null;
        let previewEditor = null;
        let chatHistory = [];
        let currentStrategy = '';
        let previousStrategy = '';
        let previewCode = '';
        let autoSettings = { backtest: false, debug: false, iterate: false };
        let isWaitingResponse = false;
        let currentStrategyMode = 'single';
        let autoSaveTimer = null;
        let lastSavedCode = '';
        
        // å·¥ä½œåŒºç®¡ç†
        let currentWorkspaceId = null;
        let workspaceList = [];
        let workspaceSaveTimer = null;

        // ==================== åˆå§‹åŒ– ====================
        require.config({ paths: { vs: '/static/node_modules/monaco-editor/min/vs' } });

        require(['vs/editor/editor.main'], function() {
            monaco.editor.defineTheme('ssquant-dark', {
                base: 'vs-dark', inherit: true,
                rules: [
                    { token: 'comment', foreground: '6A9955' },
                    { token: 'keyword', foreground: 'C586C0' },
                    { token: 'string', foreground: 'CE9178' },
                    { token: 'number', foreground: 'B5CEA8' },
                    { token: 'function', foreground: 'DCDCAA' },
                ],
                colors: {
                    'editor.background': '#0a0e17',
                    'editor.foreground': '#f1f5f9',
                    'editor.lineHighlightBackground': '#1a2234',
                    'editorLineNumber.foreground': '#64748b',
                    'editorCursor.foreground': '#3b82f6',
                    'editor.selectionBackground': '#264f78',
                }
            });

            editor = monaco.editor.create(document.getElementById('editor-container'), {
                value: '# ç­–ç•¥ä»£ç å°†åœ¨è¿™é‡Œæ˜¾ç¤º\n# åœ¨å·¦ä¾§è¾“å…¥ç­–ç•¥æè¿°ï¼Œç”Ÿæˆç­–ç•¥',
                language: 'python', theme: 'ssquant-dark',
                fontSize: 14, fontFamily: "'JetBrains Mono', monospace",
                minimap: { enabled: true }, scrollBeyondLastLine: false,
                automaticLayout: true, tabSize: 4,
            });

            diffEditor = monaco.editor.createDiffEditor(document.getElementById('diff-container'), {
                theme: 'ssquant-dark', fontSize: 14,
                fontFamily: "'JetBrains Mono', monospace",
                automaticLayout: true, readOnly: true, renderSideBySide: true
            });

            editor.onDidChangeModelContent(() => { 
                currentStrategy = editor.getValue();
                // è‡ªåŠ¨ä¿å­˜å·¥ä½œåŒºï¼ˆå·²åŒ…å«èŠ‚æµï¼‰
                autoSaveWorkspace();
            });
            loadSettings();
            initChatScroll(); // åˆå§‹åŒ–æ™ºèƒ½æ»šåŠ¨
            // å…ˆåŠ è½½å·¥ä½œåŒºï¼Œå†åŠ è½½æŠ¥å‘Šå’Œå†å²ï¼ˆè¿™æ ·æ‰èƒ½æ­£ç¡®è¿‡æ»¤ï¼‰
            loadLastWorkspace().then(() => {
                refreshReports();
                loadHistory();
            });
        });

        // è‡ªé€‚åº”è¾“å…¥æ¡†
        const chatInput = document.getElementById('chatInput');
        chatInput.addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = Math.min(this.scrollHeight, 150) + 'px';
        });
        chatInput.addEventListener('keydown', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); }
        });

        // ==================== ç¼–è¾‘å™¨ ====================
        function switchEditorTab(tab) {
            document.querySelectorAll('.editor-tab').forEach(t => t.classList.remove('active'));
            document.querySelector(`.editor-tab[data-tab="${tab}"]`)?.classList.add('active');
            
            if (tab === 'editor') {
                isInDiffMode = false;
                document.getElementById('editor-container').style.display = 'block';
                document.getElementById('diff-container').style.display = 'none';
                // åŒæ­¥ä»£ç åˆ°ç¼–è¾‘å™¨
                if (editor && currentStrategy) {
                    editor.setValue(currentStrategy);
                }
            } else {
                isInDiffMode = true;
                document.getElementById('editor-container').style.display = 'none';
                document.getElementById('diff-container').style.display = 'block';
                updateDiffView();
            }
        }

        function updateDiffView() {
            if (diffEditor && previousStrategy) {
                // ä½¿ç”¨ inline diff æ¨¡å¼ï¼ˆçº¢ç»¿æ˜¾ç¤ºåˆ é™¤/æ–°å¢ï¼‰
                diffEditor.updateOptions({ renderSideBySide: false });
                diffEditor.setModel({
                    original: monaco.editor.createModel(previousStrategy, 'python'),
                    modified: monaco.editor.createModel(currentStrategy, 'python')
                });
            }
        }

        function setEditorCode(code, autoSave = true) {
            previousStrategy = currentStrategy;
            currentStrategy = code;
            if (editor) {
                editor.setValue(code);
                // åˆ‡æ¢åˆ°ç¼–è¾‘å™¨è§†å›¾
                switchEditorTab('editor');
                // æ»šåŠ¨åˆ°é¡¶éƒ¨
                editor.revealLine(1);
            }
            
            // ä»£ç å˜åŒ–æ—¶è‡ªåŠ¨ä¿å­˜åˆ°å†å²ç‰ˆæœ¬
            if (autoSave && code && code.length > 50) {
                saveToHistory(code, true);
            }
        }

        // ç²¾ç¡®ç¼–è¾‘æ¨¡å¼ï¼šè®¾ç½®ä»£ç å¹¶è‡ªåŠ¨æ˜¾ç¤º diff è§†å›¾
        // æ˜¯å¦å¤„äºå·®å¼‚æ˜¾ç¤ºæ¨¡å¼
        let isInDiffMode = false;
        
        function setEditorCodeWithDiff(newCode, originalCode) {
            previousStrategy = originalCode;
            currentStrategy = newCode;
            
            // å§‹ç»ˆæ›´æ–°ä¸»ç¼–è¾‘å™¨çš„ä»£ç ï¼ˆç¡®ä¿è¿è¡Œå›æµ‹æ—¶ä½¿ç”¨æœ€æ–°ä»£ç ï¼‰
            if (editor) {
                editor.setValue(newCode);
            }
            
            // å¦‚æœæœ‰å·®å¼‚ï¼Œåˆ‡æ¢åˆ° inline diff æ¨¡å¼
            if (originalCode && originalCode !== newCode) {
                showInlineDiff(originalCode, newCode);
            }
            
            // ä»£ç å˜åŒ–æ—¶è‡ªåŠ¨ä¿å­˜åˆ°å†å²ç‰ˆæœ¬
            if (newCode && newCode.length > 50) {
                saveToHistory(newCode, true);
            }
        }
        
        // æ˜¾ç¤º inline diffï¼ˆåœ¨ç¼–è¾‘å™¨ä½ç½®æ˜¾ç¤ºå·®å¼‚ï¼‰
        function showInlineDiff(oldCode, newCode) {
            isInDiffMode = true;
            
            // éšè—æ™®é€šç¼–è¾‘å™¨ï¼Œæ˜¾ç¤º diff å®¹å™¨
            document.getElementById('editor-container').style.display = 'none';
            document.getElementById('diff-container').style.display = 'block';
            
            // æ›´æ–°æ ‡ç­¾çŠ¶æ€
            document.querySelectorAll('.editor-tab').forEach(t => t.classList.remove('active'));
            document.querySelector('.editor-tab[data-tab="diff"]')?.classList.add('active');
            
            // è®¾ç½® diff ç¼–è¾‘å™¨ä¸º inline æ¨¡å¼ï¼ˆä¸æ˜¯å¹¶æ’ï¼‰
            if (diffEditor) {
                diffEditor.updateOptions({ renderSideBySide: false });
                diffEditor.setModel({
                    original: monaco.editor.createModel(oldCode, 'python'),
                    modified: monaco.editor.createModel(newCode, 'python')
                });
            }
        }
        
        // é€€å‡º diff æ¨¡å¼ï¼Œæ¢å¤æ™®é€šç¼–è¾‘å™¨
        function exitDiffMode() {
            isInDiffMode = false;
            
            // æ˜¾ç¤ºæ™®é€šç¼–è¾‘å™¨ï¼Œéšè— diff å®¹å™¨
            document.getElementById('editor-container').style.display = 'block';
            document.getElementById('diff-container').style.display = 'none';
            
            // æ›´æ–°æ ‡ç­¾çŠ¶æ€
            document.querySelectorAll('.editor-tab').forEach(t => t.classList.remove('active'));
            document.querySelector('.editor-tab[data-tab="editor"]')?.classList.add('active');
            
            // åŒæ­¥ä»£ç åˆ°æ™®é€šç¼–è¾‘å™¨
            if (editor) {
                editor.setValue(currentStrategy);
            }
        }

        function copyCode() {
            navigator.clipboard.writeText(editor.getValue()).then(() => showToast('ä»£ç å·²å¤åˆ¶'));
        }

        // ==================== AI èŠå¤©ï¼ˆæµå¼ï¼‰ ====================
        let currentAbortController = null;

        async function sendMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            
            if (!message) return;
            if (isWaitingResponse) {
                showToast('è¯·ç­‰å¾…å½“å‰å¯¹è¯å®Œæˆ', 'warning');
                return;
            }

            const welcomeEl = document.getElementById('welcomeMessage');
            if (welcomeEl) welcomeEl.style.display = 'none';
            addMessage('user', message);
            input.value = '';
            input.style.height = 'auto';
            setWaitingState(true);
            
            // ç«‹å³ä¿å­˜ç”¨æˆ·æ¶ˆæ¯åˆ°å†å²
            chatHistory.push({ role: 'user', content: message });
            const aiMessageIndex = chatHistory.length;
            chatHistory.push({ role: 'assistant', content: '' });

            // æ·»åŠ AIæ¶ˆæ¯å ä½
            const aiMsgId = 'ai-msg-' + Date.now();
            addMessagePlaceholder(aiMsgId);

            // è·å–ç¼–è¾‘å™¨ä¸­çš„ä»£ç 
            const editorCode = editor ? editor.getValue() : '';
            let fullResponse = '';
            let extractedCode = null;
            let lastCodeResult = null;  // å­˜å‚¨åç«¯è¿”å›çš„ä»£ç å¤„ç†ç»“æœ
            let wasStopped = false;
            let sseBuffer = '';  // SSEæ•°æ®ç¼“å†²åŒºï¼Œå¤„ç†è·¨chunkçš„æ•°æ®

            try {
                currentAbortController = new AbortController();
                
                const response = await fetch('/api/chat/stream', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        message: message,
                        history: chatHistory,
                        editor_code: editorCode  // å‘é€ç¼–è¾‘å™¨ä¸­çš„ä»£ç 
                    }),
                    signal: currentAbortController.signal
                });

                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let lastDataTime = Date.now();
                let receivedDone = false;

                // è¶…æ—¶æ£€æµ‹ï¼ˆ45ç§’æ— æ•°æ®åˆ™è¶…æ—¶ï¼‰
                const timeoutChecker = setInterval(() => {
                    const elapsed = Date.now() - lastDataTime;
                    if (elapsed > 45000 && !receivedDone) {
                        console.warn('SSEè¯»å–è¶…æ—¶');
                        updateMessageContent(aiMsgId, fullResponse + '\n\nâš ï¸ *å“åº”è¶…æ—¶ï¼Œè¯·ç‚¹å‡»"åœæ­¢ç”Ÿæˆ"åé‡è¯•*');
                        reader.cancel();
                        clearInterval(timeoutChecker);
                    } else if (elapsed > 20000 && !receivedDone) {
                        showStuckButton(aiMsgId);
                    }
                }, 5000);

                try {
                    while (true) {
                        const { done, value } = await reader.read();
                        if (done) break;
                        
                        lastDataTime = Date.now();
                        const chunk = decoder.decode(value, { stream: true });
                        
                        // å¤„ç†å¯èƒ½è·¨chunkçš„æ•°æ®
                        sseBuffer += chunk;
                        const messages = sseBuffer.split('\n\n');
                        sseBuffer = messages.pop() || '';  // ä¿ç•™ä¸å®Œæ•´çš„æœ€åä¸€æ¡
                        
                        for (const message of messages) {
                            const lines = message.split('\n');
                            for (const line of lines) {
                                if (line.startsWith('data: ')) {
                                    try {
                                        const jsonStr = line.slice(6);
                                        if (!jsonStr.trim()) continue;
                                        const data = JSON.parse(jsonStr);
                                        if (data.error) {
                                            updateMessageContent(aiMsgId, fullResponse + `\n\nâŒ é”™è¯¯: ${data.error}`);
                                        }
                                        if (data.stopped) {
                                            wasStopped = true;
                                            updateMessageContent(aiMsgId, fullResponse + '\n\nâš ï¸ *ç”Ÿæˆå·²åœæ­¢*');
                                            break;
                                        }
                                        if (data.heartbeat) {
                                            continue;
                                        }
                                        if (data.content) {
                                            fullResponse += data.content;
                                            updateMessageContent(aiMsgId, fullResponse);
                                            
                                            // å®æ—¶æ›´æ–°èŠå¤©å†å²ä¸­çš„AIæ¶ˆæ¯
                                            if (chatHistory[aiMessageIndex]) {
                                                chatHistory[aiMessageIndex].content = fullResponse;
                                            }
                                        }
                                        if (data.done) {
                                            receivedDone = true;
                                            extractedCode = data.extracted_code;
                                            lastCodeResult = data.code_result;
                                            break;
                                        }
                                    } catch (e) {
                                        // JSONè§£æå¤±è´¥ï¼Œå¯èƒ½æ˜¯æ•°æ®ä¸å®Œæ•´ï¼Œè·³è¿‡
                                        console.warn('SSEæ•°æ®è§£æè·³è¿‡:', e.message);
                                    }
                                }
                            }
                            if (wasStopped || receivedDone) break;
                        }
                        
                        if (wasStopped || receivedDone) break;
                    }
                } finally {
                    clearInterval(timeoutChecker);
                }
                
                // ç¡®ä¿æœ€ç»ˆå†…å®¹å·²æ›´æ–°åˆ°å†å²è®°å½•
                if (chatHistory[aiMessageIndex]) {
                    chatHistory[aiMessageIndex].content = fullResponse;
                }

                // å¤„ç†ä»£ç ç»“æœ
                let codeResult = null;
                
                // ä¼˜å…ˆä½¿ç”¨åç«¯è¿”å›çš„ code_result
                if (lastCodeResult) {
                    codeResult = lastCodeResult;
                }
                
                // å¦‚æœåç«¯æ²¡æœ‰æå–åˆ°ä»£ç ï¼Œå°è¯•å‰ç«¯æå–ï¼ˆå…¼å®¹æ—§ç‰ˆï¼‰
                if (!codeResult && !extractedCode && fullResponse && !wasStopped) {
                    extractedCode = extractCodeFromText(fullResponse);
                    if (extractedCode) {
                        codeResult = { type: 'full_code', code: extractedCode };
                    }
                }
                
                // å¦‚æœåªæœ‰ extractedCodeï¼ŒåŒ…è£…ä¸º codeResult
                if (!codeResult && extractedCode) {
                    codeResult = { type: 'full_code', code: extractedCode };
                }

                // å¦‚æœæœ‰ä»£ç ç»“æœï¼Œå¤„ç†åº”ç”¨
                if (codeResult && codeResult.code) {
                    try {
                        const originalCode = editorCode;
                        
                        if (codeResult.type === 'search_replace') {
                            // ç²¾ç¡®ç¼–è¾‘æ¨¡å¼ï¼šæ˜¾ç¤º diff é¢„è§ˆ
                            
                            // æ˜¾ç¤ºä¿®æ”¹æ‘˜è¦
                            const appliedCount = codeResult.apply_result?.applied?.length || 0;
                            const failedCount = codeResult.apply_result?.failed?.length || 0;
                            
                            // ä½¿ç”¨ç®€åŒ–æ¶ˆæ¯å‡½æ•°ï¼ˆä¼šæ·»åŠ æ“ä½œæŒ‰é’®ï¼‰
                            simplifyMessageForSearchReplace(aiMsgId, fullResponse, appliedCount, failedCount);
                            
                            // ä¿å­˜åŸå§‹ä»£ç ç”¨äº diff å¯¹æ¯”
                            previousStrategy = originalCode;
                            
                            // åº”ç”¨ä¿®æ”¹åçš„ä»£ç 
                            setEditorCodeWithDiff(codeResult.code, originalCode);
                            
                            showToast(`å·²åº”ç”¨ ${appliedCount} å¤„ç²¾ç¡®ä¿®æ”¹`);
                        } else {
                            // å®Œæ•´ä»£ç æ¨¡å¼ï¼šç›´æ¥æ›¿æ¢
                            setEditorCode(codeResult.code);
                            simplifyMessageWithCode(aiMsgId, fullResponse);
                            showToast('ç­–ç•¥ä»£ç å·²æ›´æ–°å¹¶ä¿å­˜');
                        }
                        
                        // å¦‚æœå¼€å¯è‡ªåŠ¨å›æµ‹ï¼Œåˆ™è¿è¡Œå›æµ‹
                        if (autoSettings.backtest) {
                            setTimeout(() => runBacktest(), 500);
                        }
                    } catch (codeError) {
                        console.error('å¤„ç†ä»£ç ç»“æœæ—¶å‡ºé”™:', codeError);
                        showToast('ä»£ç å¤„ç†å‡ºé”™', 'warning');
                    }
                }

            } catch (error) {
                if (error.name === 'AbortError') {
                    updateMessageContent(aiMsgId, fullResponse + '\n\nâš ï¸ *ç”Ÿæˆå·²åœæ­¢*');
                } else {
                    console.error('å‘é€æ¶ˆæ¯é”™è¯¯:', error);
                    updateMessageContent(aiMsgId, `âŒ è¯·æ±‚å¤±è´¥: ${error.message}`);
                }
            } finally {
                currentAbortController = null;
                setWaitingState(false);
                
                // ç»Ÿä¸€ä¿å­˜ï¼šåªä¿å­˜å·¥ä½œåŒºï¼ˆåŒ…å«èŠå¤©è®°å½•å’Œä»£ç ï¼‰
                autoSaveWorkspace();
            }
        }

        // æ˜¾ç¤º"å¡ä½äº†"æŒ‰é’®
        let stuckButtonShown = false;
        function showStuckButton(msgId) {
            if (stuckButtonShown) return;
            stuckButtonShown = true;
            
            const msg = document.getElementById(msgId);
            if (msg) {
                const existingBtn = msg.querySelector('.stuck-btn');
                if (!existingBtn) {
                    const btn = document.createElement('button');
                    btn.className = 'btn btn-warning btn-sm stuck-btn';
                    btn.style.cssText = 'position: absolute; right: 16px; top: 16px; z-index: 10;';
                    btn.innerHTML = 'å¡ä½äº†';
                    btn.onclick = () => {
                        stopGeneration();
                        btn.remove();
                    };
                    msg.style.position = 'relative';
                    msg.appendChild(btn);
                }
            }
        }

        async function stopGeneration() {
            stuckButtonShown = false;  // é‡ç½®çŠ¶æ€
            isWaitingResponse = false;
            if (currentAbortController) {
                currentAbortController.abort();
                currentAbortController = null;
            }
            setWaitingState(false);
            fetch('/api/chat/stop', { method: 'POST' }).catch(() => {});
            showToast('å·²åœæ­¢ç”Ÿæˆ');
        }

        // ==================== æ™ºèƒ½æ»šåŠ¨ï¼ˆå‚è€ƒChatGPTï¼‰ ====================
        let userScrolledUp = false;  // ç”¨æˆ·æ˜¯å¦å‘ä¸Šæ»šåŠ¨äº†
        
        function initChatScroll() {
            const container = document.getElementById('chatMessages');
            container.addEventListener('scroll', () => {
                // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦åœ¨åº•éƒ¨ï¼ˆå…è®¸50pxè¯¯å·®ï¼‰
                const isAtBottom = container.scrollHeight - container.scrollTop - container.clientHeight < 50;
                userScrolledUp = !isAtBottom;
                
                // æ˜¾ç¤º/éšè—æ»šåŠ¨åˆ°åº•éƒ¨æŒ‰é’®
                const scrollBtn = document.getElementById('scrollToBottomBtn');
                if (scrollBtn) {
                    scrollBtn.style.display = userScrolledUp ? 'flex' : 'none';
                }
            });
        }
        
        function smartScroll() {
            // åªæœ‰å½“ç”¨æˆ·åœ¨åº•éƒ¨æ—¶æ‰è‡ªåŠ¨æ»šåŠ¨
            if (!userScrolledUp) {
                const container = document.getElementById('chatMessages');
                container.scrollTop = container.scrollHeight;
            }
        }
        
        function scrollToBottom() {
            const container = document.getElementById('chatMessages');
            container.scrollTop = container.scrollHeight;
            userScrolledUp = false;
            const scrollBtn = document.getElementById('scrollToBottomBtn');
            if (scrollBtn) scrollBtn.style.display = 'none';
        }

        function addMessage(role, content) {
            const container = document.getElementById('chatMessages');
            const div = document.createElement('div');
            div.className = `message message-${role}`;
            div.innerHTML = `<div class="message-content">${role === 'ai' ? safeMarkedParse(content) : escapeHtml(content)}</div>`;
            container.appendChild(div);
            smartScroll();
        }

        function addMessagePlaceholder(id) {
            const container = document.getElementById('chatMessages');
            const div = document.createElement('div');
            div.className = 'message message-ai';
            div.id = id;
            div.innerHTML = `<div class="message-content"><div class="typing-indicator"><div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div></div></div>`;
            container.appendChild(div);
            userScrolledUp = false;  // æ–°æ¶ˆæ¯æ—¶é‡ç½®
            smartScroll();
        }

        function updateMessageContent(id, content) {
            const msg = document.getElementById(id);
            if (msg) {
                msg.querySelector('.message-content').innerHTML = safeMarkedParse(content);
                smartScroll();
            }
        }

        function addCodeActions(id, code) {
            const msg = document.getElementById(id);
            if (msg) {
                const actions = document.createElement('div');
                actions.className = 'message-actions';
                actions.innerHTML = `
                    <button class="message-action-btn" onclick="applyCode(\`${escapeForJs(code)}\`)">âœ… åº”ç”¨ä»£ç </button>
                    <button class="message-action-btn" onclick="copyToClipboard(\`${escapeForJs(code)}\`)">ğŸ“‹ å¤åˆ¶ä»£ç </button>
                `;
                msg.appendChild(actions);
            }
        }

        // ç®€åŒ–åŒ…å«ä»£ç çš„æ¶ˆæ¯ï¼Œç§»é™¤ä»£ç å—ï¼Œæ·»åŠ æˆåŠŸæç¤ºå’Œæ“ä½œæŒ‰é’®
        function simplifyMessageWithCode(id, fullResponse) {
            const msg = document.getElementById(id);
            if (!msg) return;
            
            // ç§»é™¤ä»£ç å—ï¼Œä¿ç•™å…¶ä»–æ–‡å­—è¯´æ˜
            let cleanedResponse = fullResponse
                .replace(/```python[\s\S]*?```/g, '')
                .replace(/```py[\s\S]*?```/g, '')
                .replace(/```[\s\S]*?```/g, '')
                .trim();
            
            // å¦‚æœç§»é™¤ä»£ç åå†…å®¹å¤ªå°‘ï¼Œä½¿ç”¨é»˜è®¤è¯´æ˜
            if (cleanedResponse.length < 20) {
                cleanedResponse = 'ç­–ç•¥ä»£ç å·²ç”Ÿæˆå®Œæˆã€‚';
            }
            
            // æ·»åŠ æˆåŠŸæç¤º
            const successBadge = `
                <div style="display: inline-flex; align-items: center; gap: 8px; padding: 8px 14px; background: rgba(16, 185, 129, 0.15); border: 1px solid rgba(16, 185, 129, 0.3); border-radius: 8px; margin-bottom: 12px; color: #10b981; font-size: 13px;">
                    <span>âœ…</span>
                    <span>ç­–ç•¥ä»£ç å·²ç”Ÿæˆå®Œæˆï¼</span>
                </div>
            `;
            
            // å§‹ç»ˆæ˜¾ç¤ºæ“ä½œæŒ‰é’®ï¼ˆä¸ç®¡æ˜¯å¦å¼€å¯è‡ªåŠ¨å›æµ‹ï¼‰
            const actionButtons = getCodeActionButtons();
            
            // æ›´æ–°æ¶ˆæ¯å†…å®¹
            const contentDiv = msg.querySelector('.message-content');
            if (contentDiv) {
                contentDiv.innerHTML = successBadge + safeMarkedParse(cleanedResponse) + actionButtons;
            }
        }

        // ç²¾ç¡®ç¼–è¾‘æ¨¡å¼çš„æ¶ˆæ¯ç®€åŒ–å‡½æ•°
        function simplifyMessageForSearchReplace(id, fullResponse, appliedCount, failedCount) {
            const msg = document.getElementById(id);
            if (!msg) return;
            
            // ç§»é™¤ SEARCH/REPLACE å—ï¼Œä¿ç•™å…¶ä»–æ–‡å­—è¯´æ˜
            let cleanedResponse = fullResponse
                .replace(/<<<<<<< SEARCH[\s\S]*?>>>>>>> REPLACE/g, '')
                .replace(/```python[\s\S]*?```/g, '')
                .replace(/```py[\s\S]*?```/g, '')
                .replace(/```[\s\S]*?```/g, '')
                .trim();
            
            // å¦‚æœç§»é™¤åå†…å®¹å¤ªå°‘ï¼Œä½¿ç”¨é»˜è®¤è¯´æ˜
            if (cleanedResponse.length < 20) {
                cleanedResponse = 'ä»£ç ä¿®æ”¹å·²å®Œæˆã€‚';
            }
            
            // æ·»åŠ ç²¾ç¡®ç¼–è¾‘æˆåŠŸæç¤º
            let statusText = `ç²¾ç¡®ç¼–è¾‘å®Œæˆï¼šæˆåŠŸåº”ç”¨ ${appliedCount} å¤„ä¿®æ”¹`;
            let badgeClass = '';
            if (failedCount > 0) {
                statusText += `ï¼Œ${failedCount} å¤„æœªåŒ¹é…`;
                badgeClass = 'warning';
            }
            
            const successBadge = `
                <div class="edit-status-badge ${badgeClass}">
                    <span class="icon">${failedCount > 0 ? 'âš ï¸' : 'âœ…'}</span>
                    <span>${statusText}</span>
                </div>
            `;
            
            // æ“ä½œæŒ‰é’®
            const actionButtons = getCodeActionButtons();
            
            // æ›´æ–°æ¶ˆæ¯å†…å®¹
            const contentDiv = msg.querySelector('.message-content');
            if (contentDiv) {
                contentDiv.innerHTML = successBadge + safeMarkedParse(cleanedResponse) + actionButtons;
            }
        }

        // è·å–ä»£ç æ“ä½œæŒ‰é’®ï¼ˆå¤ç”¨ï¼‰
        function getCodeActionButtons() {
            return `
                <div class="ai-action-buttons" style="margin-top: 16px; display: flex; gap: 10px; flex-wrap: wrap;">
                    <button class="ai-action-btn primary" onclick="runBacktest()">
                        <span>â–¶</span> è¿è¡Œå›æµ‹
                    </button>
                    <button class="ai-action-btn" onclick="askIterateStrategy()">
                        <span>ğŸ”„</span> è¿­ä»£ä¼˜åŒ–
                    </button>
                    <button class="ai-action-btn" onclick="saveCurrentStrategy()">
                        <span>ğŸ’¾</span> ä¿å­˜ç­–ç•¥
                    </button>
                </div>
            `;
        }

        function applyCode(code) { setEditorCode(code); showToast('ä»£ç å·²åº”ç”¨'); }
        function copyToClipboard(text) { navigator.clipboard.writeText(text).then(() => showToast('å·²å¤åˆ¶')); }
        function clearChat() {
            if (confirm('ç¡®å®šæ¸…ç©ºèŠå¤©è®°å½•ï¼Ÿ')) {
                const chatMessages = document.getElementById('chatMessages');
                const welcomeMessage = document.getElementById('welcomeMessage');
                
                // å…ˆä¿å­˜ welcomeMessageï¼ˆå¦‚æœå­˜åœ¨ï¼‰
                if (welcomeMessage) {
                    welcomeMessage.remove();
                }
                
                // æ¸…ç©ºèŠå¤©æ¶ˆæ¯
                chatMessages.innerHTML = '';
                
                // é‡æ–°åˆ›å»ºæ¬¢è¿æ¶ˆæ¯
                const newWelcome = document.createElement('div');
                newWelcome.className = 'welcome-message';
                newWelcome.id = 'welcomeMessage';
                newWelcome.innerHTML = `
                    <div class="welcome-icon">ğŸ¤–</div>
                    <h2 class="welcome-title">æ¬¢è¿ä½¿ç”¨ SSQuant AI Agent</h2>
                    <p class="welcome-subtitle">è¾“å…¥ä½ çš„éœ€æ±‚ï¼Œæˆ‘å¯ä»¥å¸®ä½ ï¼š</p>
                    <div class="welcome-features">
                        <div class="welcome-feature"><span class="welcome-feature-icon">ğŸ“</span><span>ç”Ÿæˆé‡åŒ–äº¤æ˜“ç­–ç•¥ä»£ç </span></div>
                        <div class="welcome-feature"><span class="welcome-feature-icon">ğŸ“Š</span><span>è‡ªåŠ¨å›æµ‹å¹¶åˆ†æç»“æœ</span></div>
                        <div class="welcome-feature"><span class="welcome-feature-icon">ğŸ”§</span><span>è°ƒè¯•å’Œä¼˜åŒ–ç­–ç•¥</span></div>
                        <div class="welcome-feature"><span class="welcome-feature-icon">ğŸ’¡</span><span>è§£ç­”é‡åŒ–äº¤æ˜“é—®é¢˜</span></div>
                    </div>
                `;
                chatMessages.appendChild(newWelcome);
                
                // æ¸…ç©ºå†å²
                chatHistory = [];
                showToast('èŠå¤©è®°å½•å·²æ¸…ç©º');
                
                // åŒæ­¥åˆ°å½“å‰å·¥ä½œåŒº
                autoSaveWorkspace();
            }
        }

        // ==================== å·¥ä½œåŒºç®¡ç† ====================
        
        function toggleWorkspaceSidebar() {
            const sidebar = document.getElementById('workspaceSidebar');
            const overlay = document.getElementById('sidebarOverlay');
            const isOpen = sidebar.classList.contains('open');
            
            if (isOpen) {
                sidebar.classList.remove('open');
                overlay.classList.remove('open');
            } else {
                sidebar.classList.add('open');
                overlay.classList.add('open');
                loadWorkspaceList();
            }
        }
        
        async function loadWorkspaceList() {
            try {
                const res = await fetch('/api/workspaces');
                const data = await res.json();
                
                if (data.success) {
                    workspaceList = data.workspaces;
                    renderWorkspaceList();
                }
            } catch (e) {
                console.error('åŠ è½½å·¥ä½œåŒºåˆ—è¡¨å¤±è´¥:', e);
            }
        }
        
        function renderWorkspaceList() {
            const container = document.getElementById('workspaceList');
            
            if (workspaceList.length === 0) {
                container.innerHTML = `
                    <div class="no-data">
                        <p>æš‚æ— å·¥ä½œåŒº</p>
                        <p style="font-size: 12px; color: var(--text-muted);">ç‚¹å‡»ä¸Šæ–¹æŒ‰é’®åˆ›å»ºæ–°å·¥ä½œåŒº</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = workspaceList.map(ws => {
                const isActive = ws.id === currentWorkspaceId;
                const date = ws.updated_at ? new Date(ws.updated_at).toLocaleString('zh-CN') : '';
                return `
                    <div class="workspace-item ${isActive ? 'active' : ''}" 
                         onclick="switchWorkspace('${ws.id}')" data-id="${ws.id}">
                        <div class="workspace-item-header">
                            <span class="workspace-item-name">${escapeHtml(ws.name)}</span>
                            <div class="workspace-item-actions">
                                <button onclick="event.stopPropagation(); renameWorkspace('${ws.id}', '${escapeHtml(ws.name)}')" title="é‡å‘½å">âœï¸</button>
                                <button class="delete" onclick="event.stopPropagation(); deleteWorkspace('${ws.id}')" title="åˆ é™¤">ğŸ—‘ï¸</button>
                            </div>
                        </div>
                        <div class="workspace-item-meta">
                            ${ws.message_count} æ¡å¯¹è¯ Â· ${date}
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        async function createNewWorkspace() {
            const defaultName = generateWorkspaceName('æ–°å·¥ä½œåŒº');
            const name = prompt('è¯·è¾“å…¥å·¥ä½œåŒºåç§°:', defaultName);
            if (!name) return;
            
            // å¦‚æœAIæ­£åœ¨ç”Ÿæˆï¼Œå…ˆåœæ­¢
            if (isWaitingResponse) {
                await stopGeneration();
            }
            
            // ä¿å­˜å½“å‰å·¥ä½œåŒº
            if (currentWorkspaceId) {
                await saveCurrentWorkspace();
            }
            
            try {
                
                const res = await fetch('/api/workspace', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name })
                });
                const data = await res.json();
                
                if (data.success) {
                    currentWorkspaceId = data.workspace.id;
                    localStorage.setItem('lastWorkspaceId', currentWorkspaceId);
                    document.getElementById('currentWorkspaceName').textContent = name;
                    
                    // æ¸…ç©ºå½“å‰çŠ¶æ€
                    chatHistory = [];
                    const chatMessages = document.getElementById('chatMessages');
                    chatMessages.innerHTML = '';
                    createWelcomeMessage(chatMessages);
                    
                    if (editor) {
                        editor.setValue('');
                    }
                    currentStrategy = '';
                    previousStrategy = '';
                    
                    showToast('å·¥ä½œåŒºå·²åˆ›å»º: ' + name);
                    loadWorkspaceList();
                    toggleWorkspaceSidebar();
                    
                    // åˆ·æ–°æŠ¥å‘Šå’Œå†å²åˆ—è¡¨ï¼ˆæ–°å·¥ä½œåŒºåº”è¯¥æ˜¯ç©ºçš„ï¼‰
                    await refreshReports();
                    await loadHistory();
                }
            } catch (e) {
                showToast('åˆ›å»ºå·¥ä½œåŒºå¤±è´¥', 'error');
            }
        }
        
        function createWelcomeMessage(container) {
            const welcome = document.createElement('div');
            welcome.className = 'welcome-message';
            welcome.id = 'welcomeMessage';
            welcome.innerHTML = `
                <div class="welcome-icon">ğŸ¤–</div>
                <h2 class="welcome-title">æ¬¢è¿ä½¿ç”¨ SSQuant AI Agent</h2>
                <p class="welcome-subtitle">è¾“å…¥ä½ çš„éœ€æ±‚ï¼Œæˆ‘å¯ä»¥å¸®ä½ ï¼š</p>
                <div class="welcome-features">
                    <div class="welcome-feature"><span class="welcome-feature-icon">ğŸ“</span><span>ç”Ÿæˆé‡åŒ–äº¤æ˜“ç­–ç•¥ä»£ç </span></div>
                    <div class="welcome-feature"><span class="welcome-feature-icon">ğŸ“Š</span><span>è‡ªåŠ¨å›æµ‹å¹¶åˆ†æç»“æœ</span></div>
                    <div class="welcome-feature"><span class="welcome-feature-icon">ğŸ”§</span><span>è°ƒè¯•å’Œä¼˜åŒ–ç­–ç•¥</span></div>
                    <div class="welcome-feature"><span class="welcome-feature-icon">ğŸ’¡</span><span>è§£ç­”é‡åŒ–äº¤æ˜“é—®é¢˜</span></div>
                </div>
            `;
            container.appendChild(welcome);
        }
        
        async function switchWorkspace(workspaceId) {
            if (workspaceId === currentWorkspaceId) {
                toggleWorkspaceSidebar();
                return;
            }
            
            // å¦‚æœAIæ­£åœ¨ç”Ÿæˆï¼Œå…ˆåœæ­¢
            if (isWaitingResponse) {
                await stopGeneration();
            }
            
            // ä¿å­˜å½“å‰å·¥ä½œåŒº
            if (currentWorkspaceId) {
                await saveCurrentWorkspace();
            }
            
            try {
                const res = await fetch(`/api/workspace/${workspaceId}`);
                const data = await res.json();
                
                if (data.success) {
                    const ws = data.workspace;
                    currentWorkspaceId = ws.id;
                    localStorage.setItem('lastWorkspaceId', currentWorkspaceId);
                    document.getElementById('currentWorkspaceName').textContent = ws.name;
                    
                    // æ¢å¤å¯¹è¯å†å²
                    chatHistory = ws.chat_history || [];
                    restoreChatUI(chatHistory);
                    
                    // æ¢å¤ä»£ç 
                    if (editor) {
                        const code = ws.editor_code || '';
                        editor.setValue(code);
                        currentStrategy = code;
                    }
                    
                    showToast('å·²åˆ‡æ¢åˆ°: ' + ws.name);
                    renderWorkspaceList();
                    toggleWorkspaceSidebar();
                    
                    // åˆ·æ–°æŠ¥å‘Šå’Œå†å²åˆ—è¡¨
                    refreshReports();
                    loadHistory();
                }
            } catch (e) {
                showToast('åˆ‡æ¢å·¥ä½œåŒºå¤±è´¥', 'error');
            }
        }
        
        function restoreChatUI(history) {
            const chatMessages = document.getElementById('chatMessages');
            chatMessages.innerHTML = '';
            
            if (history.length === 0) {
                createWelcomeMessage(chatMessages);
                return;
            }
            
            history.forEach(msg => {
                const div = document.createElement('div');
                div.className = `message ${msg.role === 'user' ? 'user-message' : 'ai-message'}`;
                
                if (msg.role === 'user') {
                    div.innerHTML = `<div class="message-content">${escapeHtml(msg.content)}</div>`;
                } else {
                    div.innerHTML = `
                        <div class="message-avatar">ğŸ¤–</div>
                        <div class="message-content">${safeMarkedParse(msg.content)}</div>
                    `;
                }
                chatMessages.appendChild(div);
            });
            
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }
        
        async function saveCurrentWorkspace() {
            if (!currentWorkspaceId) return;
            
            // ä¿å­˜å½“å‰å·¥ä½œåŒºIDåˆ°localStorage
            localStorage.setItem('lastWorkspaceId', currentWorkspaceId);
            
            const editorCode = editor ? editor.getValue() : '';
            
            try {
                await fetch(`/api/workspace/${currentWorkspaceId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        chat_history: chatHistory,
                        editor_code: editorCode
                    })
                });
            } catch (e) {
                console.error('ä¿å­˜å·¥ä½œåŒºå¤±è´¥:', e);
            }
        }
        
        let lastWorkspaceSaveTime = 0;
        function autoSaveWorkspace() {
            if (!currentWorkspaceId) return;
            
            // èŠ‚æµï¼šè‡³å°‘é—´éš”3ç§’æ‰ä¿å­˜ä¸€æ¬¡
            const now = Date.now();
            const minInterval = 3000;
            
            if (workspaceSaveTimer) {
                clearTimeout(workspaceSaveTimer);
            }
            
            const timeSinceLastSave = now - lastWorkspaceSaveTime;
            const delay = timeSinceLastSave < minInterval ? minInterval : 1000;
            
            workspaceSaveTimer = setTimeout(() => {
                lastWorkspaceSaveTime = Date.now();
                saveCurrentWorkspace();
            }, delay);
        }
        
        async function renameWorkspace(workspaceId, currentName) {
            const newName = prompt('è¯·è¾“å…¥æ–°åç§°:', currentName);
            if (!newName || newName === currentName) return;
            
            try {
                await fetch(`/api/workspace/${workspaceId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name: newName })
                });
                
                if (workspaceId === currentWorkspaceId) {
                    document.getElementById('currentWorkspaceName').textContent = newName;
                }
                
                loadWorkspaceList();
                showToast('å·²é‡å‘½å');
            } catch (e) {
                showToast('é‡å‘½åå¤±è´¥', 'error');
            }
        }
        
        async function deleteWorkspace(workspaceId) {
            if (!confirm('ç¡®å®šåˆ é™¤æ­¤å·¥ä½œåŒºï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚')) return;
            
            try {
                await fetch(`/api/workspace/${workspaceId}`, { method: 'DELETE' });
                
                if (workspaceId === currentWorkspaceId) {
                    currentWorkspaceId = null;
                    localStorage.removeItem('lastWorkspaceId');
                    document.getElementById('currentWorkspaceName').textContent = 'å…¨éƒ¨æ•°æ®';
                    chatHistory = [];
                    const chatMessages = document.getElementById('chatMessages');
                    chatMessages.innerHTML = '';
                    createWelcomeMessage(chatMessages);
                    if (editor) editor.setValue('');
                    // åˆ·æ–°æŠ¥å‘Šå’Œå†å²ï¼ˆæ˜¾ç¤ºæ‰€æœ‰æ•°æ®ï¼‰
                    refreshReports();
                    loadHistory();
                }
                
                loadWorkspaceList();
                showToast('å·¥ä½œåŒºå·²åˆ é™¤');
            } catch (e) {
                showToast('åˆ é™¤å¤±è´¥', 'error');
            }
        }
        
        let workspaceInitialized = false;  // é˜²æ­¢é‡å¤åˆå§‹åŒ–
        
        async function loadLastWorkspace() {
            // é˜²æ­¢é‡å¤æ‰§è¡Œ
            if (workspaceInitialized) return;
            workspaceInitialized = true;
            
            // ä»localStorageè·å–ä¸Šæ¬¡çš„å·¥ä½œåŒºID
            const lastWorkspaceId = localStorage.getItem('lastWorkspaceId');
            
            // æ£€æŸ¥æ˜¯å¦æ˜¯æœ‰æ•ˆçš„å·¥ä½œåŒºIDï¼ˆä¸æ˜¯ nullã€undefinedã€ç©ºå­—ç¬¦ä¸²æˆ–å­—ç¬¦ä¸² "undefined"ï¼‰
            if (lastWorkspaceId && lastWorkspaceId !== 'undefined' && lastWorkspaceId !== 'null') {
                try {
                    const res = await fetch(`/api/workspace/${lastWorkspaceId}`);
                    const data = await res.json();
                    
                    if (data.success) {
                        const ws = data.workspace;
                        currentWorkspaceId = ws.id;
                        document.getElementById('currentWorkspaceName').textContent = ws.name;
                        
                        // æ¢å¤å¯¹è¯å†å²
                        if (ws.chat_history && ws.chat_history.length > 0) {
                            chatHistory = ws.chat_history;
                            restoreChatUI(chatHistory);
                        }
                        
                        // æ¢å¤ä»£ç 
                        if (editor && ws.editor_code) {
                            editor.setValue(ws.editor_code);
                            currentStrategy = ws.editor_code;
                        }
                        return;  // æˆåŠŸåŠ è½½ï¼Œç›´æ¥è¿”å›
                    } else {
                        // å·¥ä½œåŒºä¸å­˜åœ¨ï¼Œæ¸…é™¤è®°å½•
                        localStorage.removeItem('lastWorkspaceId');
                    }
                } catch (e) {
                    // åŠ è½½å¤±è´¥ï¼Œæ¸…é™¤è®°å½•
                    localStorage.removeItem('lastWorkspaceId');
                }
            } else {
                // æ¸…é™¤æ— æ•ˆçš„å€¼
                localStorage.removeItem('lastWorkspaceId');
            }
            
            // æ²¡æœ‰ä¸Šæ¬¡çš„å·¥ä½œåŒºæˆ–åŠ è½½å¤±è´¥ï¼Œè‡ªåŠ¨åˆ›å»ºé»˜è®¤å·¥ä½œåŒº
            await createDefaultWorkspace();
        }
        
        // ç”Ÿæˆå¸¦æ—¶é—´æˆ³çš„å·¥ä½œåŒºåç§°
        function generateWorkspaceName(prefix = 'å·¥ä½œåŒº') {
            const now = new Date();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            return `${prefix}_${month}${day}_${hours}${minutes}`;
        }
        
        async function createDefaultWorkspace() {
            try {
                const name = generateWorkspaceName('å·¥ä½œåŒº');
                const response = await fetch('/api/workspace', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name: name })
                });
                const data = await response.json();
                
                if (data.success) {
                    currentWorkspaceId = data.workspace_id;
                    localStorage.setItem('lastWorkspaceId', currentWorkspaceId);
                    document.getElementById('currentWorkspaceName').textContent = name;
                    loadWorkspaceList();
                }
            } catch (e) {
                // åˆ›å»ºå¤±è´¥ï¼Œä¿æŒ"å…¨éƒ¨æ•°æ®"æ¨¡å¼
                console.error('åˆ›å»ºé»˜è®¤å·¥ä½œåŒºå¤±è´¥:', e);
            }
        }

        function setWaitingState(waiting) {
            isWaitingResponse = waiting;
            const sendBtn = document.getElementById('sendBtn');
            const stopBtnContainer = document.getElementById('stopBtnContainer');
            const statusDot = document.getElementById('statusDot');
            const statusText = document.getElementById('statusText');

            if (waiting) {
                sendBtn.disabled = true;
                sendBtn.innerHTML = '<span class="loading-spinner"></span>';
                stopBtnContainer.style.display = 'flex';
                statusDot.className = 'status-dot running';
                statusText.textContent = 'AIæ€è€ƒä¸­...';
            } else {
                sendBtn.disabled = false;
                sendBtn.innerHTML = 'â¤';
                stopBtnContainer.style.display = 'none';
                statusDot.className = 'status-dot';
                statusText.textContent = 'å°±ç»ª';
            }
        }

        // ==================== å›æµ‹ ====================
        async function runBacktest() {
            // ä¼˜å…ˆä½¿ç”¨ currentStrategyï¼ˆç¡®ä¿ diff æ¨¡å¼ä¸‹ä¹Ÿèƒ½è·å–æœ€æ–°ä»£ç ï¼‰
            let code = currentStrategy;
            if (!code && editor) {
                code = editor.getValue();
            }
            // åŒæ­¥åˆ°ç¼–è¾‘å™¨ï¼ˆç¡®ä¿æ˜¾ç¤ºä¸€è‡´ï¼‰
            if (editor && code && editor.getValue() !== code) {
                editor.setValue(code);
            }
            
            if (!code || code.includes('# ç­–ç•¥ä»£ç å°†åœ¨è¿™é‡Œæ˜¾ç¤º')) {
                showToast('è¯·å…ˆç”Ÿæˆç­–ç•¥ä»£ç ', 'error');
                return;
            }

            const params = getBacktestParams();
            switchRightTab('params');
            clearLog();
            addLog('å¯åŠ¨å›æµ‹...', 'info');

            document.getElementById('statusDot').className = 'status-dot running';
            document.getElementById('statusText').textContent = 'å›æµ‹ä¸­...';

            try {
                const response = await fetch('/api/backtest/start', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ code, params, workspace_id: currentWorkspaceId || '' })
                });
                const data = await response.json();
                if (data.success) {
                    listenBacktestStatus();
                } else {
                    addLog(`é”™è¯¯: ${data.error}`, 'error');
                    resetStatus();
                    // å¦‚æœå¼€å¯è‡ªåŠ¨è°ƒè¯•ï¼Œè®©AIåˆ†æé”™è¯¯ï¼›å¦åˆ™æ˜¾ç¤ºä¿®å¤æŒ‰é’®
                    if (autoSettings.debug && data.error) {
                        setTimeout(() => autoDebugErrors([data.error]), 500);
                    } else if (data.error) {
                        showErrorWithFixButton([data.error]);
                    }
                }
            } catch (error) {
                addLog(`è¯·æ±‚å¤±è´¥: ${error.message}`, 'error');
                resetStatus();
                // å¦‚æœå¼€å¯è‡ªåŠ¨è°ƒè¯•ï¼Œè®©AIåˆ†æé”™è¯¯ï¼›å¦åˆ™æ˜¾ç¤ºä¿®å¤æŒ‰é’®
                if (autoSettings.debug) {
                    setTimeout(() => autoDebugErrors([error.message]), 500);
                } else {
                    showErrorWithFixButton([error.message]);
                }
            }
        }

        function getBacktestParams() {
            let params;
            if (currentStrategyMode === 'single') {
                params = {
                    strategy_mode: 'single',
                    symbol: document.getElementById('paramSymbol').value,
                    kline_period: document.getElementById('paramPeriod').value,
                    start_date: document.getElementById('paramStartDate').value,
                    end_date: document.getElementById('paramEndDate').value,
                    initial_capital: parseInt(document.getElementById('paramCapital').value),
                    commission: parseFloat(document.getElementById('paramCommission').value),
                    margin_rate: parseFloat(document.getElementById('paramMargin').value),
                    contract_multiplier: parseInt(document.getElementById('paramMultiplier').value),
                    price_tick: parseFloat(document.getElementById('paramPriceTick').value),
                    slippage_ticks: parseInt(document.getElementById('paramSlippage').value),
                    adjust_type: document.getElementById('paramAdjust').value,
                    lookback_bars: parseInt(document.getElementById('paramLookback').value),
                };
            } else if (currentStrategyMode === 'tick') {
                params = {
                    strategy_mode: 'tick',
                    symbol: document.getElementById('paramTickSymbol').value,
                    kline_period: 'tick',
                    start_date: document.getElementById('paramTickStartDate').value,
                    end_date: document.getElementById('paramTickEndDate').value,
                    price_tick: parseFloat(document.getElementById('paramTickPriceTick').value),
                    contract_multiplier: parseInt(document.getElementById('paramTickMultiplier').value),
                    slippage_ticks: parseInt(document.getElementById('paramTickSlippage').value),
                    lookback_bars: parseInt(document.getElementById('paramTickLookback').value),
                };
            } else {
                params = {
                    strategy_mode: 'multi',
                    start_date: document.getElementById('paramMultiStartDate').value,
                    end_date: document.getElementById('paramMultiEndDate').value,
                    initial_capital: parseInt(document.getElementById('paramMultiCapital').value),
                    commission: parseFloat(document.getElementById('paramMultiCommission').value),
                    margin_rate: parseFloat(document.getElementById('paramMultiMargin').value),
                    lookback_bars: parseInt(document.getElementById('paramMultiLookback').value),
                    align_data: document.getElementById('paramAlignData').value === 'true',
                    data_sources: getDataSources(),
                };
            }
            
            // ä¿å­˜å›æµ‹å‚æ•°åˆ°æœ¬åœ°
            saveBacktestParams(params);
            return params;
        }
        
        // ä¿å­˜å›æµ‹å‚æ•°ï¼ˆé˜²æŠ–ï¼‰
        let saveParamsTimer = null;
        function saveBacktestParams(params) {
            if (saveParamsTimer) clearTimeout(saveParamsTimer);
            saveParamsTimer = setTimeout(async () => {
                try {
                    await fetch('/api/settings', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ backtest_params: params })
                    });
                    console.log('å›æµ‹å‚æ•°å·²ä¿å­˜');
                } catch (e) { console.error('ä¿å­˜å›æµ‹å‚æ•°å¤±è´¥:', e); }
            }, 500);
        }

        let backtestErrors = [];  // æ”¶é›†å›æµ‹é”™è¯¯
        let lastReportPath = null;  // æœ€åä¸€æ¬¡å›æµ‹æŠ¥å‘Šè·¯å¾„
        let backtestHasError = false;  // æ˜¯å¦æœ‰é”™è¯¯
        let backtestWorker = null;  // Web Workerï¼ˆåå°ä¸æ–­å¼€ï¼‰
        let isBacktestRunning = false;  // å›æµ‹æ˜¯å¦æ­£åœ¨è¿è¡Œ

        // åˆ›å»º Web Worker æ¥å¤„ç† SSEï¼ˆåå°ä¸ä¼šæ–­å¼€ï¼‰
        function createBacktestWorker() {
            const workerCode = `
                let eventSource = null;
                
                self.onmessage = function(e) {
                    if (e.data.action === 'start') {
                        if (eventSource) eventSource.close();
                        
                        eventSource = new EventSource(e.data.url);
                        
                        eventSource.onmessage = function(event) {
                            self.postMessage({ type: 'message', data: event.data });
                        };
                        
                        eventSource.onerror = function() {
                            self.postMessage({ type: 'error' });
                            eventSource.close();
                            eventSource = null;
                        };
                    } else if (e.data.action === 'stop') {
                        if (eventSource) {
                            eventSource.close();
                            eventSource = null;
                        }
                    }
                };
            `;
            
            const blob = new Blob([workerCode], { type: 'application/javascript' });
            return new Worker(URL.createObjectURL(blob));
        }

        function listenBacktestStatus() {
            // å…³é—­å·²æœ‰ Worker
            if (backtestWorker) {
                backtestWorker.postMessage({ action: 'stop' });
                backtestWorker.terminate();
                backtestWorker = null;
            }
            
            backtestErrors = [];
            lastReportPath = null;
            backtestHasError = false;
            isBacktestRunning = true;
            
            // åˆ›å»ºæ–°çš„ Worker
            backtestWorker = createBacktestWorker();
            
            backtestWorker.onmessage = function(e) {
                if (e.data.type === 'message') {
                    const data = JSON.parse(e.data.data);
                    handleBacktestMessage(data);
                } else if (e.data.type === 'error') {
                    // Worker ä¸­çš„ SSE å‡ºé”™ï¼Œå›é€€åˆ°ä¸»çº¿ç¨‹ SSE
                    if (isBacktestRunning) {
                        fallbackToMainThreadSSE();
                    }
                }
            };
            
            // å¯åŠ¨ Worker ä¸­çš„ SSE
            backtestWorker.postMessage({ 
                action: 'start', 
                url: window.location.origin + '/api/backtest/status' 
            });
        }
        
        // å¤„ç†å›æµ‹æ¶ˆæ¯
        function handleBacktestMessage(data) {
            if (data.type === 'done') { 
                if (backtestWorker) {
                    backtestWorker.postMessage({ action: 'stop' });
                    backtestWorker.terminate();
                    backtestWorker = null;
                }
                isBacktestRunning = false;
                resetStatus(); 
                refreshReports(); 
                
                if (backtestErrors.length > 0 || backtestHasError) {
                    const uniqueErrors = [...new Set(backtestErrors)];
                    if (autoSettings.debug) {
                        setTimeout(() => autoDebugErrors(uniqueErrors), 500);
                    } else {
                        showErrorWithFixButton(uniqueErrors);
                    }
                } else if (lastReportPath) {
                    if (autoSettings.debug) {
                        setTimeout(() => analyzeReport(lastReportPath), 1000);
                    } else {
                        showBacktestSuccessButtons(lastReportPath);
                    }
                }
                return; 
            }
            if (data.type === 'heartbeat') return;
            if (data.type === 'report') {
                lastReportPath = data.path;
                refreshReports();
                switchRightTab('report');
            }
            if (data.type === 'error') {
                backtestHasError = true;
                if (!backtestErrors.includes(data.message)) {
                    backtestErrors.push(data.message);
                }
            }
            addLog(data.message, data.type);
        }
        
        // å›é€€åˆ°ä¸»çº¿ç¨‹ SSEï¼ˆå¦‚æœ Worker ä¸æ”¯æŒï¼‰
        function fallbackToMainThreadSSE() {
            const eventSource = new EventSource('/api/backtest/status');
            
            eventSource.onmessage = function(event) {
                const data = JSON.parse(event.data);
                if (data.type === 'done') {
                    eventSource.close();
                }
                handleBacktestMessage(data);
            };
            
            eventSource.onerror = function() {
                eventSource.close();
                resetStatus();
            };
        }

        // è‡ªåŠ¨è°ƒè¯•ï¼šè®©AIåˆ†æé”™è¯¯å¹¶ä¿®å¤
        async function autoDebugErrors(errors) {
            const errorMsg = errors.join('\n');
            
            // æ„å»ºè°ƒè¯•è¯·æ±‚
            const debugPrompt = `å›æµ‹è¿è¡Œå‡ºé”™ï¼Œè¯·åˆ†æä»¥ä¸‹é”™è¯¯å¹¶ä¿®å¤ä»£ç ï¼š

ã€é”™è¯¯ä¿¡æ¯ã€‘
${errorMsg}

è¯·åˆ†æé”™è¯¯åŸå› ï¼Œä½¿ç”¨ SEARCH/REPLACE æ ¼å¼ç²¾ç¡®ä¿®å¤å‡ºé”™çš„ä»£ç éƒ¨åˆ†ã€‚`;
            
            // è‡ªåŠ¨å‘é€åˆ°AI
            document.getElementById('chatInput').value = debugPrompt;
            showToast('è‡ªåŠ¨è°ƒè¯•ï¼šæ­£åœ¨åˆ†æé”™è¯¯...');
            await sendMessage();
        }

        // å­˜å‚¨æœ€åä¸€æ¬¡é”™è¯¯ä¿¡æ¯ï¼ˆç”¨äºä¿®å¤æŒ‰é’®ï¼‰
        let lastBacktestError = '';

        // æ˜¾ç¤ºé”™è¯¯å¹¶æä¾›ä¿®å¤æŒ‰é’®ï¼ˆéè‡ªåŠ¨æ¨¡å¼ï¼‰
        function showErrorWithFixButton(errors) {
            const errorMsg = errors.join('\n');
            lastBacktestError = errorMsg;  // ä¿å­˜é”™è¯¯ä¿¡æ¯
            
            // åœ¨èŠå¤©ä¸­æ·»åŠ é”™è¯¯æç¤ºå’Œä¿®å¤æŒ‰é’®
            const errorId = 'error-msg-' + Date.now();
            const container = document.getElementById('chatMessages');
            const div = document.createElement('div');
            div.className = 'message message-assistant';
            div.id = errorId;
            div.innerHTML = `
                <div class="message-avatar">ğŸ¤–</div>
                <div class="message-bubble">
                    <div class="message-content">
                        <div style="display: inline-flex; align-items: center; gap: 8px; padding: 8px 14px; background: rgba(239, 68, 68, 0.15); border: 1px solid rgba(239, 68, 68, 0.3); border-radius: 8px; margin-bottom: 12px; color: #ef4444; font-size: 13px;">
                            <span>âŒ</span>
                            <span>å›æµ‹è¿è¡Œå‡ºé”™</span>
                        </div>
                        <pre style="background: var(--bg-primary); padding: 12px; border-radius: 6px; font-size: 12px; overflow-x: auto; white-space: pre-wrap; word-break: break-all;">${escapeHtml(errorMsg)}</pre>
                        <div class="ai-action-buttons" style="margin-top: 16px; display: flex; gap: 10px; flex-wrap: wrap;">
                            <button class="ai-action-btn danger" onclick="askFixErrors()">
                                <span>ğŸ”§</span> è®©AIä¿®å¤
                            </button>
                            <button class="ai-action-btn" onclick="runBacktest()">
                                <span>ğŸ”„</span> é‡æ–°å›æµ‹
                            </button>
                        </div>
                    </div>
                </div>
            `;
            container.appendChild(div);
            smartScroll();
        }

        // è¯·æ±‚AIä¿®å¤é”™è¯¯
        async function askFixErrors() {
            if (!lastBacktestError) {
                showToast('æ²¡æœ‰é”™è¯¯ä¿¡æ¯', 'error');
                return;
            }
            
            const debugPrompt = `å›æµ‹è¿è¡Œå‡ºé”™ï¼Œè¯·åˆ†æä»¥ä¸‹é”™è¯¯å¹¶ä¿®å¤ä»£ç ï¼š

ã€é”™è¯¯ä¿¡æ¯ã€‘
${lastBacktestError}

è¯·åˆ†æé”™è¯¯åŸå› ï¼Œä½¿ç”¨ SEARCH/REPLACE æ ¼å¼ç²¾ç¡®ä¿®å¤å‡ºé”™çš„ä»£ç éƒ¨åˆ†ã€‚`;
            
            document.getElementById('chatInput').value = debugPrompt;
            await sendMessage();
        }

        // è¯·æ±‚AIè¿­ä»£ä¼˜åŒ–ç­–ç•¥
        async function askIterateStrategy() {
            const iteratePrompt = `è¯·åˆ†æå½“å‰ç­–ç•¥ä»£ç ï¼Œç»™å‡ºä¼˜åŒ–å»ºè®®å¹¶ä¿®æ”¹ä»£ç ã€‚

å¯ä»¥ä»ä»¥ä¸‹æ–¹é¢è€ƒè™‘ä¼˜åŒ–ï¼š
1. æ·»åŠ æ­¢æŸæ­¢ç›ˆé€»è¾‘
2. ä¼˜åŒ–å…¥åœºæ¡ä»¶
3. æ·»åŠ è¿‡æ»¤å™¨å‡å°‘å‡ä¿¡å·
4. æ”¹è¿›èµ„é‡‘ç®¡ç†

è¯·ä½¿ç”¨ SEARCH/REPLACE æ ¼å¼ç²¾ç¡®ä¿®æ”¹éœ€è¦æ”¹åŠ¨çš„éƒ¨åˆ†ï¼Œä¸è¦é‡å†™æ•´ä¸ªä»£ç ã€‚`;
            
            document.getElementById('chatInput').value = iteratePrompt;
            await sendMessage();
        }

        // ä¿å­˜å½“å‰ç­–ç•¥åˆ°å†å²
        async function saveCurrentStrategy() {
            // å¦‚æœåœ¨diffæ¨¡å¼ï¼Œä½¿ç”¨ currentStrategyï¼›å¦åˆ™ä½¿ç”¨ç¼–è¾‘å™¨å†…å®¹
            let code = '';
            if (isInDiffMode && currentStrategy) {
                code = currentStrategy;
            } else if (editor) {
                code = editor.getValue();
            }
            
            if (!code || code.length < 50) {
                showToast('æ²¡æœ‰å¯ä¿å­˜çš„ç­–ç•¥ä»£ç ', 'error');
                return;
            }
            
            // ä¿å­˜åˆ°å†å²ç‰ˆæœ¬
            await saveToHistory(code, false);
            
            // åŒæ—¶ä¿å­˜å·¥ä½œåŒº
            if (currentWorkspaceId) {
                await saveCurrentWorkspace();
            }
            
            loadHistory();  // åˆ·æ–°å†å²åˆ—è¡¨
        }

        // æ˜¾ç¤ºå›æµ‹æˆåŠŸåçš„æ“ä½œæŒ‰é’®
        function showBacktestSuccessButtons(reportPath) {
            const filename = reportPath.split(/[\/\\]/).pop();
            
            const container = document.getElementById('chatMessages');
            const div = document.createElement('div');
            div.className = 'message message-assistant';
            div.innerHTML = `
                <div class="message-avatar">ğŸ¤–</div>
                <div class="message-bubble">
                    <div class="message-content">
                        <div style="display: inline-flex; align-items: center; gap: 8px; padding: 8px 14px; background: rgba(16, 185, 129, 0.15); border: 1px solid rgba(16, 185, 129, 0.3); border-radius: 8px; margin-bottom: 12px; color: #10b981; font-size: 13px;">
                            <span>âœ…</span>
                            <span>å›æµ‹å®Œæˆï¼</span>
                        </div>
                        <p style="margin-bottom: 12px; color: var(--text-secondary);">å›æµ‹æŠ¥å‘Šå·²ç”Ÿæˆï¼Œæ‚¨å¯ä»¥ï¼š</p>
                        <div class="ai-action-buttons" style="display: flex; gap: 10px; flex-wrap: wrap;">
                            <button class="ai-action-btn primary" onclick="openReport('${filename}')">
                                <span>ğŸ“Š</span> æŸ¥çœ‹æŠ¥å‘Š
                            </button>
                            <button class="ai-action-btn" onclick="askAnalyzeReport('${encodeURIComponent(reportPath)}')">
                                <span>ğŸ”</span> AIåˆ†ææŠ¥å‘Š
                            </button>
                            <button class="ai-action-btn" onclick="askIterateStrategy()">
                                <span>ğŸ”„</span> è¿­ä»£ä¼˜åŒ–
                            </button>
                        </div>
                    </div>
                </div>
            `;
            container.appendChild(div);
            smartScroll();
        }

        // è¯·æ±‚AIåˆ†ææŠ¥å‘Š
        async function askAnalyzeReport(encodedPath) {
            const reportPath = decodeURIComponent(encodedPath);
            await analyzeReport(reportPath);
        }

        // åˆ†æå›æµ‹æŠ¥å‘Š
        async function analyzeReport(reportPath) {
            try {
                const filename = reportPath.split(/[\/\\]/).pop();
                const response = await fetch(`/api/report/${filename}`);
                const data = await response.json();
                
                if (data.success) {
                    // æå–æŠ¥å‘Šä¸­çš„å…³é”®æŒ‡æ ‡ï¼ˆç®€åŒ–ç‰ˆæœ¬ï¼Œåªå–æ–‡æœ¬å†…å®¹ï¼‰
                    const parser = new DOMParser();
                    const doc = parser.parseFromString(data.content, 'text/html');
                    const textContent = doc.body ? doc.body.innerText.substring(0, 2000) : 'æ— æ³•è§£ææŠ¥å‘Š';
                    
                    const analyzePrompt = `è¯·åˆ†æä»¥ä¸‹å›æµ‹æŠ¥å‘Šï¼Œç»™å‡ºæ”¹è¿›å»ºè®®ï¼š

ã€å›æµ‹æŠ¥å‘Šæ‘˜è¦ã€‘
${textContent}

è¯·åˆ†æï¼š
1. ç­–ç•¥è¡¨ç°å¦‚ä½•ï¼Ÿ
2. ä¸»è¦é—®é¢˜æ˜¯ä»€ä¹ˆï¼Ÿ
3. æœ‰ä»€ä¹ˆæ”¹è¿›å»ºè®®ï¼Ÿ`;
                    
                    document.getElementById('chatInput').value = analyzePrompt;
                    showToast('è‡ªåŠ¨åˆ†æï¼šæ­£åœ¨åˆ†æå›æµ‹æŠ¥å‘Š...');
                    await sendMessage();
                }
            } catch (error) {
                console.error('åˆ†ææŠ¥å‘Šå¤±è´¥:', error);
            }
        }

        function resetStatus() {
            document.getElementById('statusDot').className = 'status-dot';
            document.getElementById('statusText').textContent = 'å°±ç»ª';
        }

        // ==================== æŠ¥å‘Šåˆ—è¡¨ ====================
        async function refreshReports() {
            try {
                // æ·»åŠ æ—¶é—´æˆ³é˜²æ­¢ç¼“å­˜
                const timestamp = Date.now();
                let url = '/api/reports';
                if (currentWorkspaceId) {
                    url += `?workspace_id=${currentWorkspaceId}&_t=${timestamp}`;
                } else {
                    url += `?_t=${timestamp}`;
                }
                const response = await fetch(url);
                const data = await response.json();
                const container = document.getElementById('reportList');
                const actionsDiv = document.getElementById('reportActions');

                if (data.success && data.reports.length > 0) {
                    actionsDiv.style.display = 'flex';
                    container.innerHTML = data.reports.map(r => `
                        <div class="report-item">
                            <div class="report-item-content" onclick="openReport('${r.name}')">
                                <div class="report-item-name">${r.name}</div>
                                <div class="report-item-time">${r.modified}</div>
                            </div>
                            <button class="delete-btn" onclick="event.stopPropagation(); deleteReport('${r.name}')" title="åˆ é™¤">âœ•</button>
                        </div>
                    `).join('');
                } else {
                    actionsDiv.style.display = 'none';
                    container.innerHTML = '<div class="no-data"><div class="no-data-icon">ğŸ“ˆ</div><p>æš‚æ— å›æµ‹æŠ¥å‘Š</p></div>';
                }
            } catch (error) {
                console.error('åˆ·æ–°æŠ¥å‘Šå¤±è´¥:', error);
            }
        }

        async function openReport(filename) {
            try {
                const response = await fetch(`/api/report/${filename}`);
                const data = await response.json();
                if (data.success) {
                    document.getElementById('reportModalTitle').textContent = `ğŸ“Š ${filename}`;
                    document.getElementById('reportIframe').srcdoc = data.content;
                    openModal('reportModal');
                }
            } catch (error) {
                showToast('åŠ è½½æŠ¥å‘Šå¤±è´¥', 'error');
            }
        }

        // åˆ é™¤å•ä¸ªæŠ¥å‘Š
        async function deleteReport(filename) {
            if (!confirm(`ç¡®å®šè¦åˆ é™¤æŠ¥å‘Š "${filename}" å—ï¼Ÿ`)) return;
            try {
                const response = await fetch(`/api/report/${filename}`, { method: 'DELETE' });
                const data = await response.json();
                if (data.success) {
                    showToast('æŠ¥å‘Šå·²åˆ é™¤');
                    refreshReports();
                } else {
                    showToast(data.error || 'åˆ é™¤å¤±è´¥', 'error');
                }
            } catch (error) {
                showToast('åˆ é™¤æŠ¥å‘Šå¤±è´¥', 'error');
            }
        }

        // æ¸…ç©ºæ‰€æœ‰æŠ¥å‘Š
        async function clearAllReports() {
            if (!confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰å›æµ‹æŠ¥å‘Šå—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼')) return;
            try {
                const response = await fetch('/api/reports/clear', { method: 'DELETE' });
                const data = await response.json();
                if (data.success) {
                    showToast(`å·²æ¸…ç©º ${data.count} ä¸ªæŠ¥å‘Š`);
                    refreshReports();
                } else {
                    showToast(data.error || 'æ¸…ç©ºå¤±è´¥', 'error');
                }
            } catch (error) {
                showToast('æ¸…ç©ºæŠ¥å‘Šå¤±è´¥', 'error');
            }
        }

        // åˆ é™¤å•ä¸ªå†å²è®°å½•
        async function deleteHistoryItem(itemId) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤æ­¤å†å²è®°å½•å—ï¼Ÿ')) return;
            try {
                const response = await fetch(`/api/history/${itemId}`, { method: 'DELETE' });
                const data = await response.json();
                if (data.success) {
                    showToast('å†å²è®°å½•å·²åˆ é™¤');
                    loadHistory();
                } else {
                    showToast(data.error || 'åˆ é™¤å¤±è´¥', 'error');
                }
            } catch (error) {
                showToast('åˆ é™¤å†å²å¤±è´¥', 'error');
            }
        }

        // æ¸…ç©ºæ‰€æœ‰å†å²è®°å½•
        async function clearAllHistory() {
            if (!confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰å†å²è®°å½•å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼')) return;
            try {
                const response = await fetch('/api/history/clear', { method: 'DELETE' });
                const data = await response.json();
                if (data.success) {
                    showToast(`å·²æ¸…ç©º ${data.count} æ¡å†å²è®°å½•`);
                    loadHistory();
                } else {
                    showToast(data.error || 'æ¸…ç©ºå¤±è´¥', 'error');
                }
            } catch (error) {
                showToast('æ¸…ç©ºå†å²å¤±è´¥', 'error');
            }
        }

        // ==================== å³ä¾§é¢æ¿ ====================
        function switchRightTab(tab) {
            document.querySelectorAll('.right-tab').forEach(t => t.classList.remove('active'));
            document.querySelector(`.right-tab[data-tab="${tab}"]`).classList.add('active');
            document.querySelectorAll('.tab-pane').forEach(p => p.classList.remove('active'));
            document.getElementById(`tab${tab.charAt(0).toUpperCase() + tab.slice(1)}`).classList.add('active');
            if (tab === 'history') loadHistory();
        }

        function switchStrategyMode(mode) {
            currentStrategyMode = mode;
            document.querySelectorAll('.mode-tab').forEach(t => t.classList.remove('active'));
            document.querySelector(`.mode-tab[data-mode="${mode}"]`).classList.add('active');
            document.querySelectorAll('.mode-content').forEach(c => c.classList.remove('active'));
            document.getElementById(`mode${mode.charAt(0).toUpperCase() + mode.slice(1)}`).classList.add('active');
            
            // åˆ‡æ¢åˆ°å¤šå“ç§æ¨¡å¼æ—¶æ¸²æŸ“æ•°æ®æºåˆ—è¡¨
            if (mode === 'multi') {
                renderDataSources();
            }
        }

        // ==================== å¤šæ•°æ®æºç®¡ç† ====================
        let dataSources = [
            { symbol: 'rb888', kline_period: '5m', adjust_type: '1', price_tick: 1, contract_multiplier: 10, slippage_ticks: 1 },
            { symbol: 'rb888', kline_period: '15m', adjust_type: '1', price_tick: 1, contract_multiplier: 10, slippage_ticks: 1 }
        ];

        function renderDataSources() {
            const container = document.getElementById('dataSourcesList');
            if (!container) return;
            
            container.innerHTML = dataSources.map((ds, idx) => `
                <div class="data-source-card" data-index="${idx}">
                    <div class="data-source-header">
                        <span class="data-source-index">æ•°æ®æº ${idx}</span>
                        <button class="btn-remove-source" onclick="removeDataSource(${idx})" ${dataSources.length <= 1 ? 'disabled style="opacity:0.5"' : ''}>åˆ é™¤</button>
                    </div>
                    <div class="data-source-grid">
                        <div class="data-source-item">
                            <label>åˆçº¦ä»£ç </label>
                            <input type="text" value="${ds.symbol}" onchange="updateDataSource(${idx}, 'symbol', this.value)">
                        </div>
                        <div class="data-source-item">
                            <label>Kçº¿å‘¨æœŸ</label>
                            <select onchange="updateDataSource(${idx}, 'kline_period', this.value)">
                                <option value="1m" ${ds.kline_period === '1m' ? 'selected' : ''}>1åˆ†é’Ÿ</option>
                                <option value="5m" ${ds.kline_period === '5m' ? 'selected' : ''}>5åˆ†é’Ÿ</option>
                                <option value="15m" ${ds.kline_period === '15m' ? 'selected' : ''}>15åˆ†é’Ÿ</option>
                                <option value="30m" ${ds.kline_period === '30m' ? 'selected' : ''}>30åˆ†é’Ÿ</option>
                                <option value="1h" ${ds.kline_period === '1h' ? 'selected' : ''}>1å°æ—¶</option>
                                <option value="1d" ${ds.kline_period === '1d' ? 'selected' : ''}>æ—¥çº¿</option>
                            </select>
                        </div>
                        <div class="data-source-item">
                            <label>å¤æƒç±»å‹</label>
                            <select onchange="updateDataSource(${idx}, 'adjust_type', this.value)">
                                <option value="0" ${ds.adjust_type === '0' ? 'selected' : ''}>ä¸å¤æƒ</option>
                                <option value="1" ${ds.adjust_type === '1' ? 'selected' : ''}>åå¤æƒ</option>
                            </select>
                        </div>
                        <div class="data-source-item">
                            <label>æœ€å°å˜åŠ¨ä»·ä½</label>
                            <input type="text" value="${ds.price_tick}" onchange="updateDataSource(${idx}, 'price_tick', parseFloat(this.value))">
                        </div>
                        <div class="data-source-item">
                            <label>åˆçº¦ä¹˜æ•°</label>
                            <input type="number" value="${ds.contract_multiplier}" onchange="updateDataSource(${idx}, 'contract_multiplier', parseInt(this.value))">
                        </div>
                        <div class="data-source-item">
                            <label>æ»‘ç‚¹è·³æ•°</label>
                            <input type="number" value="${ds.slippage_ticks}" onchange="updateDataSource(${idx}, 'slippage_ticks', parseInt(this.value))">
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function addDataSource() {
            dataSources.push({
                symbol: 'rb888',
                kline_period: '5m',
                adjust_type: '1',
                price_tick: 1,
                contract_multiplier: 10,
                slippage_ticks: 1
            });
            renderDataSources();
        }

        function removeDataSource(idx) {
            if (dataSources.length <= 1) return;
            dataSources.splice(idx, 1);
            renderDataSources();
        }

        function updateDataSource(idx, field, value) {
            if (dataSources[idx]) {
                dataSources[idx][field] = value;
            }
        }

        function getDataSources() {
            return dataSources;
        }

        async function loadHistory() {
            try {
                // æ·»åŠ æ—¶é—´æˆ³é˜²æ­¢ç¼“å­˜
                const timestamp = Date.now();
                let url = '/api/history';
                if (currentWorkspaceId) {
                    url += `?workspace_id=${currentWorkspaceId}&_t=${timestamp}`;
                } else {
                    url += `?_t=${timestamp}`;
                }
                const response = await fetch(url);
                const data = await response.json();
                const container = document.getElementById('historyList');
                const actionsDiv = document.getElementById('historyActions');

                if (data.success && data.history.length > 0) {
                    actionsDiv.style.display = 'flex';
                    // å€’åºæ˜¾ç¤ºï¼ˆæœ€æ–°çš„åœ¨ä¸Šé¢ï¼‰
                    const items = [...data.history].reverse();
                    container.innerHTML = items.map((item, i) => {
                        // ä½¿ç”¨é¡¹ç›®è‡ªèº«çš„idï¼ˆå¦‚æœæœ‰ï¼‰ï¼Œå¦åˆ™ä½¿ç”¨è®¡ç®—çš„ç´¢å¼•
                        const itemId = item.id !== undefined ? item.id : (data.history.length - 1 - i);
                        const autoTag = item.auto_saved ? '<span class="auto-save-tag">è‡ªåŠ¨</span>' : '';
                        const timeStr = formatHistoryTime(item.timestamp);
                        const strategyName = item.name || item.strategy_file?.split(/[\/\\]/).pop() || 'ç­–ç•¥ç‰ˆæœ¬';
                        return `
                            <div class="history-item">
                                <div class="history-item-header">
                                    <span class="history-item-time">${timeStr}</span>
                                    <span class="history-item-badge">v${data.history.length - i}</span>
                                    ${autoTag}
                                    <button class="delete-btn" onclick="deleteHistoryItem(${itemId})" title="åˆ é™¤">âœ•</button>
                                </div>
                                <div class="history-item-name">${strategyName}</div>
                                <div class="history-item-actions">
                                    <button class="message-action-btn" onclick="previewHistory(${itemId})">é¢„è§ˆ</button>
                                    <button class="message-action-btn" onclick="loadHistoryCode(${itemId})">åŠ è½½</button>
                                    ${item.report_path ? `<button class="message-action-btn" onclick="openReport('${item.report_path.split(/[\/\\]/).pop()}')">æŠ¥å‘Š</button>` : ''}
                                </div>
                            </div>
                        `;
                    }).join('');
                } else {
                    actionsDiv.style.display = 'none';
                    container.innerHTML = '<div class="no-data">æš‚æ— å†å²è®°å½•<br><small>AIç”Ÿæˆæˆ–æ‰‹åŠ¨ä¿å­˜çš„ç­–ç•¥ä¼šæ˜¾ç¤ºåœ¨è¿™é‡Œ</small></div>';
                }
            } catch (error) {
                console.error('åŠ è½½å†å²å¤±è´¥:', error);
            }
        }

        function formatHistoryTime(timestamp) {
            if (!timestamp) return '';
            // timestampæ ¼å¼: YYYYMMDD_HHMMSS
            const match = timestamp.match(/(\d{4})(\d{2})(\d{2})_(\d{2})(\d{2})(\d{2})/);
            if (match) {
                return `${match[2]}-${match[3]} ${match[4]}:${match[5]}`;
            }
            return timestamp;
        }

        async function previewHistory(index) {
            try {
                const response = await fetch(`/api/history/preview/${index}`);
                const data = await response.json();
                
                if (data.success && data.code) {
                    // ä½¿ç”¨å¼¹çª—æ˜¾ç¤ºé¢„è§ˆ
                    openHistoryPreviewModal(data, index);
                } else {
                    showToast('åŠ è½½é¢„è§ˆå¤±è´¥', 'error');
                }
            } catch (error) {
                showToast('åŠ è½½é¢„è§ˆå¤±è´¥', 'error');
            }
        }

        function openHistoryPreviewModal(data, index) {
            // ä¿å­˜é¢„è§ˆä»£ç 
            previewCode = data.code;
            historyPreviewIndex = index;
            
            // è®¾ç½®æ ‡é¢˜
            document.getElementById('codePreviewTitle').textContent = `ğŸ“ ${data.name || 'å†å²ç­–ç•¥é¢„è§ˆ'}`;
            
            // æ‰“å¼€æ¨¡æ€æ¡†
            openModal('codePreviewModal');
            
            // å»¶è¿Ÿåˆ›å»º/æ›´æ–°é¢„è§ˆç¼–è¾‘å™¨
            setTimeout(() => {
                if (!previewEditor) {
                    previewEditor = monaco.editor.create(document.getElementById('codePreviewEditor'), {
                        value: previewCode,
                        language: 'python',
                        theme: 'ssquant-dark',
                        fontSize: 14,
                        fontFamily: "'JetBrains Mono', monospace",
                        readOnly: true,
                        automaticLayout: true,
                    });
                } else {
                    previewEditor.setValue(previewCode);
                }
            }, 100);
        }
        
        let historyPreviewIndex = null;

        async function loadHistoryCode(index) {
            try {
                const response = await fetch(`/api/history/${index}`);
                const data = await response.json();
                if (data.success && data.item.code) { 
                    setEditorCode(data.item.code); 
                    lastSavedCode = data.item.code; // æ ‡è®°ä¸ºå·²ä¿å­˜çŠ¶æ€ï¼Œé¿å…é‡å¤ä¿å­˜
                    showToast('å·²åŠ è½½å†å²ç‰ˆæœ¬'); 
                }
            } catch (error) { console.error('åŠ è½½å†å²ä»£ç å¤±è´¥:', error); }
        }

        // ==================== æ—¥å¿— ====================
        function addLog(message, type = 'info') {
            const container = document.getElementById('runLog');
            const line = document.createElement('div');
            line.className = `log-line ${type}`;
            line.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            container.appendChild(line);
            container.scrollTop = container.scrollHeight;
        }
        function clearLog() { document.getElementById('runLog').innerHTML = ''; }

        // ==================== è®¾ç½® ====================
        function openModal(id) { document.getElementById(id).classList.add('active'); }
        function closeModal(id) { document.getElementById(id).classList.remove('active'); }
        function openSettingsModal() { openModal('settingsModal'); }

        // æä¾›å•†é¢„è®¾é…ç½®
        const providerPresets = {
            'DeepSeek': { base_url: 'https://api.deepseek.com/v1', model: 'deepseek-chat' },
            'OpenAI': { base_url: 'https://api.openai.com/v1', model: 'gpt-4o' },
            'Claude': { base_url: 'https://api.anthropic.com/v1', model: 'claude-3-opus-20240229' },
            'Qwen': { base_url: 'https://dashscope.aliyuncs.com/compatible-mode/v1', model: 'qwen-max' },
            'Moonshot': { base_url: 'https://api.moonshot.cn/v1', model: 'moonshot-v1-8k' },
            'Zhipu': { base_url: 'https://open.bigmodel.cn/api/paas/v4', model: 'glm-4' },
            'Custom': { base_url: '', model: '' }
        };

        function onProviderChange() {
            const provider = document.getElementById('settingProvider').value;
            if (provider !== 'Custom' && providerPresets[provider]) {
                const preset = providerPresets[provider];
                document.getElementById('settingBaseUrl').value = preset.base_url;
                document.getElementById('settingModel').value = preset.model;
            }
        }

        async function loadSettings() {
            try {
                const response = await fetch('/api/settings');
                const data = await response.json();
                if (data.success) {
                    // AIè®¾ç½®
                    document.getElementById('settingProvider').value = data.ai_settings.provider || 'Custom';
                    document.getElementById('settingBaseUrl').value = data.ai_settings.base_url || 'https://api.deepseek.com/v1';
                    document.getElementById('settingModel').value = data.ai_settings.model;
                    document.getElementById('settingApiKey').value = data.ai_settings.api_key;
                    document.getElementById('settingTemp').value = data.ai_settings.temperature;
                    document.getElementById('tempValue').textContent = data.ai_settings.temperature;
                    
                    // è‡ªåŠ¨è®¾ç½®
                    autoSettings = {
                        backtest: data.auto_settings.auto_backtest,
                        debug: data.auto_settings.auto_debug,
                        iterate: data.auto_settings.auto_iterate
                    };
                    updateAutoToggles();
                    
                    // å›æµ‹å‚æ•° - å•å“ç§
                    const bp = data.backtest_params;
                    if (bp) {
                        // å•å“ç§å‚æ•°
                        setValueSafe('paramSymbol', bp.symbol);
                        setValueSafe('paramPeriod', bp.kline_period);
                        setValueSafe('paramStartDate', bp.start_date);
                        setValueSafe('paramEndDate', bp.end_date);
                        setValueSafe('paramCapital', bp.initial_capital);
                        setValueSafe('paramCommission', bp.commission);
                        setValueSafe('paramMargin', bp.margin_rate);
                        setValueSafe('paramMultiplier', bp.contract_multiplier);
                        setValueSafe('paramPriceTick', bp.price_tick);
                        setValueSafe('paramSlippage', bp.slippage_ticks);
                        setValueSafe('paramAdjust', bp.adjust_type);
                        setValueSafe('paramLookback', bp.lookback_bars);
                        
                        // TICKå‚æ•°
                        setValueSafe('paramTickSymbol', bp.symbol);
                        setValueSafe('paramTickStartDate', bp.start_date);
                        setValueSafe('paramTickEndDate', bp.end_date);
                        setValueSafe('paramTickPriceTick', bp.price_tick);
                        setValueSafe('paramTickMultiplier', bp.contract_multiplier);
                        setValueSafe('paramTickSlippage', bp.slippage_ticks);
                        setValueSafe('paramTickLookback', bp.lookback_bars);
                        
                        // å¤šå“ç§å‚æ•°
                        setValueSafe('paramMultiStartDate', bp.start_date);
                        setValueSafe('paramMultiEndDate', bp.end_date);
                        setValueSafe('paramMultiCapital', bp.initial_capital);
                        setValueSafe('paramMultiCommission', bp.commission);
                        setValueSafe('paramMultiMargin', bp.margin_rate);
                        setValueSafe('paramMultiLookback', bp.lookback_bars);
                        setValueSafe('paramAlignData', bp.align_data ? 'true' : 'false');
                        
                        // åŠ è½½æ•°æ®æºé…ç½®
                        if (bp.data_sources && bp.data_sources.length > 0) {
                            dataSources = bp.data_sources;
                            renderDataSources();
                        }
                    }
                }
            } catch (error) { console.error('åŠ è½½è®¾ç½®å¤±è´¥:', error); }
        }
        
        function setValueSafe(id, value) {
            const el = document.getElementById(id);
            if (el && value !== undefined) el.value = value;
        }

        async function saveSettings() {
            const settings = {
                ai_settings: {
                    provider: document.getElementById('settingProvider').value,
                    base_url: document.getElementById('settingBaseUrl').value.trim(),
                    model: document.getElementById('settingModel').value.trim(),
                    api_key: document.getElementById('settingApiKey').value,
                    temperature: parseFloat(document.getElementById('settingTemp').value)
                }
            };
            try {
                await fetch('/api/settings', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(settings)
                });
                showToast('è®¾ç½®å·²ä¿å­˜');
                closeModal('settingsModal');
            } catch (error) { showToast('ä¿å­˜å¤±è´¥', 'error'); }
        }

        function resetSettings() {
            document.getElementById('settingProvider').value = 'DeepSeek';
            document.getElementById('settingBaseUrl').value = 'https://api.deepseek.com/v1';
            document.getElementById('settingModel').value = 'deepseek-chat';
            document.getElementById('settingApiKey').value = '';
            document.getElementById('settingTemp').value = '0.7';
            document.getElementById('tempValue').textContent = '0.7';
        }

        // ==================== Auto Toggles ====================
        function toggleAuto(type) {
            autoSettings[type] = !autoSettings[type];
            updateAutoToggles();
            fetch('/api/settings', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    auto_settings: {
                        auto_backtest: autoSettings.backtest,
                        auto_debug: autoSettings.debug,
                        auto_iterate: autoSettings.iterate
                    }
                })
            });
        }

        function updateAutoToggles() {
            document.getElementById('toggleBacktest').classList.toggle('active', autoSettings.backtest);
            document.getElementById('toggleDebug').classList.toggle('active', autoSettings.debug);
            document.getElementById('toggleIterate').classList.toggle('active', autoSettings.iterate);
        }

        // ==================== ç¤ºä¾‹ç­–ç•¥ ====================
        async function openExamplesModal() {
            openModal('examplesModal');
            try {
                const response = await fetch('/api/examples');
                const data = await response.json();
                const container = document.getElementById('examplesList');

                if (data.success && data.examples.length > 0) {
                    container.innerHTML = data.examples.map(e => `
                        <div class="history-item">
                            <div class="history-item-name">${e.name}</div>
                            <div class="history-item-actions">
                                <button class="message-action-btn" onclick="previewExample('${e.path.replace(/\\/g, '\\\\')}', '${e.name}')">é¢„è§ˆä»£ç </button>
                                <button class="message-action-btn" onclick="loadExample('${e.path.replace(/\\/g, '\\\\')}')">åŠ è½½ç­–ç•¥</button>
                            </div>
                        </div>
                    `).join('');
                }
            } catch (error) { console.error('åŠ è½½ç¤ºä¾‹å¤±è´¥:', error); }
        }

        async function previewExample(path, name) {
            try {
                const filename = path.split(/[\/\\]/).pop();
                const response = await fetch(`/api/example/${filename}`);
                const data = await response.json();

                if (data.success) {
                    previewCode = data.content;
                    document.getElementById('codePreviewTitle').textContent = `ğŸ“ ${name}`;
                    closeModal('examplesModal');
                    openModal('codePreviewModal');

                    // å»¶è¿Ÿåˆ›å»ºé¢„è§ˆç¼–è¾‘å™¨
                    setTimeout(() => {
                        if (!previewEditor) {
                            previewEditor = monaco.editor.create(document.getElementById('codePreviewEditor'), {
                                value: previewCode,
                                language: 'python', theme: 'ssquant-dark',
                                fontSize: 14, fontFamily: "'JetBrains Mono', monospace",
                                readOnly: true, automaticLayout: true,
                            });
                        } else {
                            previewEditor.setValue(previewCode);
                        }
                    }, 100);
                }
            } catch (error) { showToast('åŠ è½½å¤±è´¥', 'error'); }
        }

        async function loadExample(path) {
            try {
                const filename = path.split(/[\/\\]/).pop();
                const response = await fetch(`/api/example/${filename}`);
                const data = await response.json();
                if (data.success) {
                    setEditorCode(data.content);
                    closeModal('examplesModal');
                    showToast('å·²åŠ è½½ç¤ºä¾‹ç­–ç•¥');
                }
            } catch (error) { showToast('åŠ è½½å¤±è´¥', 'error'); }
        }

        function applyPreviewCode() {
            if (previewCode) {
                setEditorCode(previewCode);
                closeModal('codePreviewModal');
                showToast('å·²åº”ç”¨åˆ°ç¼–è¾‘å™¨');
            }
        }

        // ==================== ä¿å­˜ç­–ç•¥ ====================
        // æ‰‹åŠ¨ä¿å­˜ç­–ç•¥ç‰ˆæœ¬ï¼ˆåº•éƒ¨æŒ‰é’®å’ŒAIæ“ä½œæŒ‰é’®å…±ç”¨ï¼‰
        async function saveStrategy() {
            await saveCurrentStrategy();
        }

        async function saveToHistory(code, autoSave = false) {
            if (!code || code.length < 50) return;
            if (code === lastSavedCode) {
                if (!autoSave) showToast('ä»£ç æœªå˜åŒ–');
                return;
            }
            
            try {
                const response = await fetch('/api/history/save', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        code: code,
                        auto_save: autoSave,
                        workspace_id: currentWorkspaceId || ''
                    })
                });
                const data = await response.json();
                
                if (data.success && !data.skipped) {
                    lastSavedCode = code;
                    if (!autoSave) {
                        showToast('å·²ä¿å­˜åˆ°å†å²ç‰ˆæœ¬');
                    }
                    // åˆ·æ–°å†å²åˆ—è¡¨ï¼ˆå¦‚æœå½“å‰åœ¨å†å²æ ‡ç­¾ï¼‰
                    if (document.getElementById('tabHistory').classList.contains('active')) {
                        loadHistory();
                    }
                } else if (!autoSave && data.skipped) {
                    showToast('ä»£ç æœªå˜åŒ–');
                }
            } catch (error) {
                if (!autoSave) showToast('ä¿å­˜å¤±è´¥', 'error');
            }
        }

        // ==================== å·¥å…·å‡½æ•° ====================
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function escapeForJs(str) {
            return str.replace(/\\/g, '\\\\').replace(/`/g, '\\`').replace(/\$/g, '\\$');
        }

        // å‰ç«¯ä»£ç æå–ï¼ˆä½œä¸ºåå¤‡ï¼‰
        function extractCodeFromText(text) {
            if (!text) return null;
            
            // å°è¯•æå–å®Œæ•´çš„ ```python ä»£ç å—
            let match = text.match(/```python\s*([\s\S]*?)```/);
            if (match && match[1] && match[1].trim().length > 50) {
                return match[1].trim();
            }
            
            // å°è¯•æå–å®Œæ•´çš„ ```py ä»£ç å—
            match = text.match(/```py\s*([\s\S]*?)```/);
            if (match && match[1] && match[1].trim().length > 50) {
                return match[1].trim();
            }
            
            // å°è¯•æå–æ™®é€š ``` ä»£ç å—
            const matches = text.match(/```\s*([\s\S]*?)```/g);
            if (matches) {
                for (const m of matches) {
                    const code = m.replace(/```\w*\s*/g, '').replace(/```/g, '').trim();
                    if (code.length > 50 && (code.includes('def ') || code.includes('import ') || code.includes('class '))) {
                        return code;
                    }
                }
            }
            
            // å¤„ç†ä¸å®Œæ•´çš„ä»£ç å—ï¼ˆæœ‰å¼€å¤´æ²¡ç»“å°¾ï¼Œç»­å†™æ—¶å¯èƒ½å‘ç”Ÿï¼‰
            match = text.match(/```python\s*([\s\S]*)$/);
            if (match && match[1]) {
                const code = match[1].trim();
                if (code.length > 100 && (code.includes('def ') || code.includes('import '))) {
                    return code;
                }
            }
            
            // å¤„ç† ```py å¼€å¤´çš„ä¸å®Œæ•´ä»£ç å—
            match = text.match(/```py\s*([\s\S]*)$/);
            if (match && match[1]) {
                const code = match[1].trim();
                if (code.length > 100 && (code.includes('def ') || code.includes('import '))) {
                    return code;
                }
            }
            
            return null;
        }

        function showToast(message, type = 'success') {
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            toast.textContent = message;
            document.body.appendChild(toast);
            setTimeout(() => { toast.style.opacity = '0'; setTimeout(() => toast.remove(), 300); }, 2000);
        }

        // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
        document.querySelectorAll('.modal-overlay').forEach(overlay => {
            overlay.addEventListener('click', function(e) {
                if (e.target === this) this.classList.remove('active');
            });
        });
    </script>
</body>
</html>

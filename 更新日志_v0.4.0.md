# ssquant v0.4.0 æ›´æ–°æ—¥å¿—

> å‘å¸ƒæ—¥æœŸï¼š2026-01-23
> 
> æœ¬ç‰ˆæœ¬æ ¸å¿ƒæ–°å¢**åˆçº¦å‚æ•°è‡ªåŠ¨è·å–**åŠŸèƒ½ï¼Œæ— éœ€æ‰‹åŠ¨å¡«å†™åˆçº¦ä¹˜æ•°ã€æœ€å°è·³åŠ¨ã€ä¿è¯é‡‘ç‡ã€æ‰‹ç»­è´¹ç­‰å‚æ•°ã€‚

---

## ğŸ“¦ ä¸€ã€æ–°å¢åŠŸèƒ½

### 1.1 åˆçº¦ä¿¡æ¯è‡ªåŠ¨è·å–æœåŠ¡ï¼ˆæ ¸å¿ƒæ–°åŠŸèƒ½ï¼‰

**æ–°å¢æ–‡ä»¶ï¼š** `ssquant/data/contract_info.py`

ä»è¿œç¨‹ API è‡ªåŠ¨è·å–åˆçº¦äº¤æ˜“å‚æ•°ï¼Œæœ¬åœ°ç¼“å­˜ 4 å°æ—¶è‡ªåŠ¨æ›´æ–°ã€‚

```python
from ssquant.data.contract_info import get_trading_params, get_main_contract

# è·å–äº¤æ˜“å‚æ•°
params = get_trading_params('au2602')
# è¿”å›: {'contract_multiplier': 1000, 'price_tick': 0.02, 'margin_rate': 0.08, ...}

# è·å–ä¸»åŠ›åˆçº¦ä»£ç 
main = get_main_contract('au')  # è¿”å›: 'au2602'
```

**æ ¸å¿ƒç±» `ContractInfoService`ï¼š**
- `get_contract_info(symbol)` - è·å–åˆçº¦å®Œæ•´ä¿¡æ¯
- `get_trading_params(symbol)` - è·å–äº¤æ˜“å‚æ•°
- `get_main_contract(variety)` - è·å–ä¸»åŠ›åˆçº¦ä»£ç 
- `get_sub_main_contract(variety)` - è·å–æ¬¡ä¸»åŠ›åˆçº¦ä»£ç 
- `list_varieties()` - åˆ—å‡ºæ‰€æœ‰å“ç§
- `refresh()` - å¼ºåˆ¶åˆ·æ–°

### 1.2 é…ç½®ç³»ç»Ÿå‡çº§ - è‡ªåŠ¨å‚æ•°

**ä¿®æ”¹æ–‡ä»¶ï¼š** `ssquant/config/trading_config.py`

**æ–°å¢å…¨å±€å¼€å…³ï¼š**
```python
ENABLE_CLOUD_DATA = True       # äº‘ç«¯æ•°æ®å¼€å…³
ENABLE_REMOTE_ADJUST = False   # è¿œç¨‹å¤æƒå¼€å…³ï¼ˆæœåŠ¡å™¨å‡çº§ä¸­ï¼‰
```

**`get_config()` æ–°å¢ `auto_params` å‚æ•°ï¼š**
```python
# v0.3.9 éœ€è¦æ‰‹åŠ¨å¡«å†™
config = get_config(RunMode.BACKTEST,
    symbol='au888',
    price_tick=0.02,              # æ‰‹åŠ¨
    contract_multiplier=1000,     # æ‰‹åŠ¨
    margin_rate=0.17,             # æ‰‹åŠ¨
    commission=0.000001,          # æ‰‹åŠ¨
)

# v0.4.0 è‡ªåŠ¨è·å–
config = get_config(RunMode.BACKTEST,
    symbol='au888',               # åªéœ€åˆçº¦ä»£ç ï¼Œå…¶ä»–è‡ªåŠ¨è·å–
    start_date='2025-01-01',
)

# ç¦ç”¨è‡ªåŠ¨å‚æ•°
config = get_config(RunMode.BACKTEST, auto_params=False, ...)

# æ‰‹åŠ¨è¦†ç›–ä¼˜å…ˆ
config = get_config(RunMode.BACKTEST, symbol='au888', price_tick=0.05, ...)
```

### 1.3 ç­–ç•¥ API æ–°å¢è´¦æˆ·æŸ¥è¯¢æ–¹æ³•

**ä¿®æ”¹æ–‡ä»¶ï¼š** `ssquant/api/strategy_api.py`

**æ–°å¢è´¦æˆ·èµ„é‡‘æŸ¥è¯¢ï¼ˆå›æµ‹/SIMNOW/å®ç›˜å‡å¯ç”¨ï¼‰ï¼š**
```python
api.get_account()           # è·å–å®Œæ•´è´¦æˆ·ä¿¡æ¯
api.get_balance()           # è·å–è´¦æˆ·æƒç›Š
api.get_available()         # è·å–å¯ç”¨èµ„é‡‘
api.get_position_profit()   # è·å–æŒä»“ç›ˆäº
api.get_close_profit()      # è·å–å¹³ä»“ç›ˆäº
api.get_margin()            # è·å–å ç”¨ä¿è¯é‡‘
api.get_commission()        # è·å–ç´¯è®¡æ‰‹ç»­è´¹
```

**æ–°å¢ CTP æŸ¥è¯¢æ–¹æ³•ï¼ˆSIMNOW/å®ç›˜ï¼‰ï¼š**
```python
api.query_account()              # æŸ¥è¯¢è´¦æˆ·èµ„é‡‘
api.query_position(symbol="")    # æŸ¥è¯¢æŒä»“
api.query_trades(symbol="")      # æŸ¥è¯¢æˆäº¤è®°å½•
```

### 1.4 å›æµ‹æ¨¡å¼è´¦æˆ·ä¿¡æ¯å®æ—¶æ›´æ–°

**ä¿®æ”¹æ–‡ä»¶ï¼š** `ssquant/backtest/backtest_core.py`

- æ–°å¢ `backtest_account_info` å­—å…¸
- æ–°å¢ `_update_backtest_account()` æ–¹æ³•
- å›æµ‹æ¨¡å¼ä¸‹ `api.get_account()` ç­‰æ–¹æ³•è¿”å›å®æ—¶è®¡ç®—çš„è´¦æˆ·ä¿¡æ¯

### 1.5 æ–°å¢ç¤ºä¾‹ç­–ç•¥

**æ–°å¢æ–‡ä»¶ï¼š** `examples/B_auto_params_demo.py`

æ¼”ç¤ºè‡ªåŠ¨å‚æ•°è·å–åŠŸèƒ½çš„å®Œæ•´ç¤ºä¾‹ã€‚

---

## ğŸ”§ äºŒã€åŠŸèƒ½ä¼˜åŒ–

### 2.1 æ•°æ®è·å–ä¼˜åŒ–

**ä¿®æ”¹æ–‡ä»¶ï¼š** `ssquant/data/historical_preloader.py`

- æ–°å¢ `_is_cloud_enabled()` - æ£€æŸ¥äº‘ç«¯æ•°æ®å¼€å…³çŠ¶æ€
- æ–°å¢ `_fetch_from_cloud()` - äº‘ç«¯æ•°æ®è·å–ï¼ˆå— `ENABLE_CLOUD_DATA` æ§åˆ¶ï¼‰
- æ–°å¢ `check_available_data()` - æ£€æŸ¥æœ¬åœ°å¯ç”¨æ•°æ®ä¿¡æ¯

### 2.2 æ•°æ®åº“å†™å…¥ä¼˜åŒ–

**ä¿®æ”¹æ–‡ä»¶ï¼š** `ssquant/data/api_data_fetcher.py`

- æ–°å¢çº¿ç¨‹å®‰å…¨çš„æ•°æ®åº“å†™å…¥é” `_db_write_locks`
- æ–°å¢ `_get_db_lock()` - è·å–æ•°æ®åº“é”ï¼ˆæ”¯æŒå¤šçº¿ç¨‹å¹¶å‘ï¼‰
- æ–°å¢ `append_kline_fast()` - å¿«é€Ÿè¿½åŠ  Kçº¿ï¼ˆINSERT OR IGNOREï¼Œä¸åšå»é‡ï¼‰
- æ–°å¢ `_insert_dataframe()` - åŸç”Ÿ SQL INSERT æ›¿ä»£ pandas to_sql

### 2.3 å®ç›˜äº¤æ˜“é€‚é…å™¨ä¼˜åŒ–

**ä¿®æ”¹æ–‡ä»¶ï¼š** `ssquant/backtest/live_trading_adapter.py`

- **Kçº¿èšåˆå…³é”®ä¿®å¤** - å¤„ç†å†å²æ•°æ®é¢„åŠ è½½åçš„çŠ¶æ€ä¸ä¸€è‡´é—®é¢˜ï¼š
  ```python
  # ã€å…³é”®ä¿®å¤ã€‘é¢„åŠ è½½åªè®¾ç½®äº† last_kline_timeï¼Œä½†æ²¡æœ‰è®¾ç½® current_kline
  # å¯¼è‡´ä»¥ä¸‹åœºæ™¯å¤±è´¥ï¼š
  #   1. åŒä¸€åˆ†é’Ÿæ¢å¤ï¼škline_time == last_kline_timeï¼Œè¿›å…¥elseä½†current_klineæ˜¯None
  #   2. æ—¶é—´å›é€€ï¼škline_time < last_kline_timeï¼ˆå¼‚å¸¸æ•°æ®ï¼‰
  # è§£å†³æ–¹æ¡ˆï¼šå½“æ£€æµ‹åˆ°çŠ¶æ€ä¸ä¸€è‡´æ—¶ï¼Œé‡ç½® last_kline_time
  if self.last_kline_time is not None and self.current_kline is None:
      self.last_kline_time = None
  ```
- ä»£ç é‡æ„ä¼˜åŒ–ï¼ˆ-398 è¡Œ / +297 è¡Œï¼‰
- ç¨³å®šæ€§æå‡

### 2.4 æ•°æ®æ¨¡å—å¯¼å‡ºæ›´æ–°

**ä¿®æ”¹æ–‡ä»¶ï¼š** `ssquant/data/__init__.py`

æ–°å¢å¯¼å‡ºï¼š
```python
from .contract_info import (
    get_trading_params,
    get_main_contract,
    get_contract_info,
    get_contract_service,
    refresh_contracts,
    list_varieties,
)
```

---

## ğŸ“ ä¸‰ã€æ–‡ä»¶å˜æ›´ç»Ÿè®¡

| æ–‡ä»¶ | å˜æ›´ç±»å‹ | è¯´æ˜ |
|-----|---------|------|
| `ssquant/data/contract_info.py` | **æ–°å¢** | åˆçº¦ä¿¡æ¯æœåŠ¡ (441è¡Œ) |
| `examples/B_auto_params_demo.py` | **æ–°å¢** | è‡ªåŠ¨å‚æ•°ç¤ºä¾‹ (308è¡Œ) |
| `ssquant/config/trading_config.py` | ä¿®æ”¹ | +auto_params, +å¼€å…³ |
| `ssquant/api/strategy_api.py` | ä¿®æ”¹ | +è´¦æˆ·æŸ¥è¯¢API |
| `ssquant/backtest/backtest_core.py` | ä¿®æ”¹ | +å›æµ‹è´¦æˆ·ä¿¡æ¯ |
| `ssquant/data/historical_preloader.py` | ä¿®æ”¹ | +äº‘ç«¯å¼€å…³æ£€æŸ¥ |
| `ssquant/data/api_data_fetcher.py` | ä¿®æ”¹ | +çº¿ç¨‹å®‰å…¨å†™å…¥ |
| `ssquant/backtest/live_trading_adapter.py` | ä¿®æ”¹ | é‡æ„ä¼˜åŒ– |
| `ssquant/data/__init__.py` | ä¿®æ”¹ | +åˆçº¦æœåŠ¡å¯¼å‡º |

---

## ğŸš€ å››ã€å‡çº§æŒ‡å—

### 4.1 ä» v0.3.9 å‡çº§

1. å°† `ss040/ssquant` è¦†ç›–åˆ° `ssquant/`
2. å°† `ss040/examples` è¦†ç›–åˆ° `examples/`

### 4.2 ä½¿ç”¨è‡ªåŠ¨å‚æ•°

```python
# åªéœ€å¡«å†™åˆçº¦ä»£ç ï¼Œå…¶ä»–å‚æ•°è‡ªåŠ¨è·å–
config = get_config(RunMode.BACKTEST,
    symbol='au888',
    start_date='2025-01-01',
    initial_capital=500000,
)

# æ§åˆ¶å°ä¼šæ˜¾ç¤ºè‡ªåŠ¨è·å–çš„å‚æ•°ï¼š
# [è‡ªåŠ¨å‚æ•°] au888(é»„é‡‘) -> contract_multiplier=1000, price_tick=0.02, margin_rate=0.17, æ‰‹ç»­è´¹=10å…ƒ/æ‰‹
```

---

## âš ï¸ äº”ã€æ³¨æ„äº‹é¡¹

1. **é¦–æ¬¡è¿è¡Œéœ€ç½‘ç»œ** - ä» kanpan789.com æ‹‰å–åˆçº¦ä¿¡æ¯
2. **ç¼“å­˜ä½ç½®** - `data_cache/contract_info_cache.json`
3. **ç¼“å­˜æœ‰æ•ˆæœŸ** - 4 å°æ—¶è‡ªåŠ¨æ›´æ–°
4. **è¿œç¨‹å¤æƒå…³é—­** - `ENABLE_REMOTE_ADJUST = False`ï¼ˆæœåŠ¡å™¨å‡çº§ä¸­ï¼‰
5. **å‘åå…¼å®¹** - `auto_params=False` å¯ç¦ç”¨è‡ªåŠ¨å‚æ•°

---

## ğŸ“ è”ç³»æˆ‘ä»¬

- å®˜ç½‘ï¼šhttps://ai.kanpan789.com
- Giteeï¼šhttps://gitee.com/ssquant/ssquant
